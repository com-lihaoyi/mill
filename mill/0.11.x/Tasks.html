<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tasks :: The Mill Build Tool</title>
    <link rel="canonical" href="https://mill-build.org/mill/fundamentals/tasks.html" />
    <link rel="prev" href="Out_Dir.html" />
    <link rel="next" href="Modules.html" />
    <meta name="generator" content="Antora 3.1.12" />
    <link rel="stylesheet" href="../../_/css/site.css" />
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-1C582ZJR85"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-1C582ZJR85')</script>
<link rel="icon" href="../../_/favicon.png" type="image/x-icon" />
  
  <style>
  /* auto-hyphenation is super ugly */
  *{
    hyphens: manual !important;
  }

  /* Reduce font size from 17px to something reasonable */
  .doc {
   font-size: 16px !important;
  }
  .doc pre {
   font-size: 14px !important;
  }
  /* Shrink unreasonably large top bar */
  nav.navbar{
    height: 2.5rem;
  }
  body.article{
    padding-top: 2.5rem;
  }
  div.nav-container{
    top: 2.5rem;
  }
  div.toolbar{
    top: 2.5rem;
  }
  aside.nav{
    top: 2.5rem;
    height: calc(100vh - 2.5rem);
  }
  </style></head><body class="article">
  
<header class="header">
  
  <script>
  gtag('config', 'AW-16649289906');

  document.addEventListener('DOMContentLoaded', function() {
  const links = document.querySelectorAll('a');
    links.forEach(link => {
      if (link.textContent.trim().toLowerCase() === 'download') {
        link.addEventListener('click', function(event) {
          console.log("download link clicked")
          gtag('event', 'conversion', {'send_to': 'AW-16649289906/rsphCKfVq8QZELKBgIM-'});
        });
      }
    });
  });
  </script>
  <nav class="navbar">
    <div class="navbar-brand">
      <!-- TODO: add mill icon -->
      <a class="navbar-item" href="https://mill-build.org"><img src="../../_/logo-white.svg" height="20" /> The Mill Build Tool</a>
      <div class="navbar-item search">
        <input id="search-input" type="text" placeholder="Search the docs" />
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill">GitHub</a>
        <a class="navbar-item" href="https://mill-build.org/blog/index.html">Blog</a>
        <a class="navbar-item" href="https://mill-build.org/api/latest/mill.html">API</a>
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill/issues">Issues</a>
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill/discussions">Discuss</a>


            <!--
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Documentation</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#"></a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Plugins</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
        -->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="mill" data-version="0.11.x">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list">

  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Java Quick Start</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Java_Intro_to_Mill.html">Introduction to Mill for Java</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Java_Installation_IDE_Support.html">Installation and IDE Support</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Java_Builtin_Commands.html">Built-in Commands</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Java_Build_Examples.html">Java Build Examples</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Java_Module_Config.html">Java Module Configuration</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Java_Web_Build_Examples.html">Java Web Build Examples</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Java_Case_Study_Netty.html">Java Case Study: Netty</a>
  </li>
</ul>
  </li>

  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Scala Quick Start</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Scala_Intro_to_Mill.html">Introduction to Mill for Scala</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Scala_Installation_IDE_Support.html">Installation and IDE Support</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Scala_Builtin_Commands.html">Built-in Commands</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Scala_Build_Examples.html">Scala Build Examples</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Scala_Module_Config.html">Scala Module Configuration</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Scala_Web_Build_Examples.html">Scala Web Build Examples</a>
  </li>
</ul>
  </li>

  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Mill In Depth</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Library_Dependencies.html">Library Dependencies in Mill</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Out_Dir.html">The Output Directory</a>
  </li>

  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="Tasks.html">Tasks</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Modules.html">Modules</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Cross_Builds.html">Cross Builds</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Target_Query_Syntax.html">Target Query Syntax</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Extending_Mill.html">Extending Mill</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="The_Mill_Evaluation_Model.html">The Mill Evaluation Model</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Mill Plugins</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Using_Plugins.html">Using Plugins</a>
  </li>

  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="Contrib_Plugins.html">Contrib Plugins</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/artifactory.html">Artifactory</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/bintray.html">Bintray</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/bloop.html">Bloop</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/buildinfo.html">BuildInfo</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="Plugin_BSP.html">BSP - Build Server Protocol</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/codeartifact.html">Codeartifact</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/docker.html">Docker</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/flyway.html">Flyway</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/gitlab.html">Gitlab</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/jmh.html">JMH</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/playlib.html">Play Framework</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/proguard.html">Proguard</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/scalapblib.html">ScalaPB</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/scoverage.html">Scoverage</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/testng.html">TestNG</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/twirllib.html">Twirl</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="contrib/versionfile.html">Version file</a>
  </li>
</ul>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Thirdparty_Plugins.html">Third-Party Plugins</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Mill_Design_Principles.html">Mill Design Principles</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="External_References.html">External References</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://mill-build.org/api/latest/mill/index.html">Mill Scaladoc</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="Changelog.html">Changelog</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Mill Documentation</span>
    <span class="version">0.11.13</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../index.html">Mill Documentation</a></div>
      <ul class="versions">
        <li class="version">
          <a href="../main-branch/index.html">main-branch</a>
        </li>
        <li class="version is-latest">
          <a href="../index.html">1.0.4</a>
        </li>
        <li class="version">
          <a href="../dev-1.0.4-8-28c1bd/index.html">dev-1.0.4-8-28c1bd</a>
        </li>
        <li class="version">
          <a href="../0.12.x/index.html">0.12.14</a>
        </li>
        <li class="version is-current">
          <a href="index.html">0.11.13</a>
        </li>
        <li class="version">
          <a href="../0.10.15/index.html">0.10.15</a>
        </li>
        <li class="version">
          <a href="../0.9.12/index.html">0.9.12</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../blog/index.html">The Mill Build Engineering Blog</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">

<div class="toolbar" role="navigation" style="position: fixed; top: 2.5rem; height: 2rem; left: 0px;">
<button class="nav-toggle"></button>
</div>
<div class="toolbar" style="position: fixed; top: 2.5rem; height: 1.5rem; right: 0px;">
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Tasks</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>One of Mill’s core abstractions is its <em>Task Graph</em>: this is how Mill defines,
orders and caches work it needs to do, and exists independently of any support
for building Scala.</p>
</div>
<div class="paragraph">
<p>Mill target graphs are primarily built using methods and macros defined on
<code>mill.define.Target</code>, aliased as <code>T</code> for conciseness:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://mill-build.org/api/latest/mill/define/Target$.html">mill.define.Target</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_task_cheat_sheet"><a class="anchor" href="#_task_cheat_sheet"></a>Task Cheat Sheet</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following table might help you make sense of the small collection of
different Task types:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;" />
<col style="width: 14.2857%;" />
<col style="width: 14.2857%;" />
<col style="width: 14.2857%;" />
<col style="width: 14.2857%;" />
<col style="width: 14.2857%;" />
<col style="width: 14.2858%;" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Target</th>
<th class="tableblock halign-left valign-top">Command</th>
<th class="tableblock halign-left valign-top">Source/Input</th>
<th class="tableblock halign-left valign-top">Anonymous Task</th>
<th class="tableblock halign-left valign-top">Persistent Target</th>
<th class="tableblock halign-left valign-top">Worker</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cached to Disk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON Writable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON Readable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CLI Runnable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Takes Arguments</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cached In-Memory</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following is a simple self-contained example using Mill to compile Java:</p>
</div>
<div class="listingblock">
<div class="title">build.sc (<a href="https://github.com/com-lihaoyi/mill/releases/download/0.11.13/0.11.13-example-tasks-1-task-graph.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/0.11.13/example/tasks/1-task-graph">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">import mill._

def mainClass: T[Option[String]] = Some(&quot;foo.Foo&quot;)

def sources = T.source(millSourcePath / &quot;src&quot;)
def resources = T.source(millSourcePath / &quot;resources&quot;)

def compile = T {
  val allSources = os.walk(sources().path)
  os.proc(&quot;javac&quot;, allSources, &quot;-d&quot;, T.dest).call()
  PathRef(T.dest)
}

def assembly = T {
  for(p &lt;- Seq(compile(), resources())) os.copy(p.path, T.dest, mergeFolders = true)

  val mainFlags = mainClass().toSeq.flatMap(Seq(&quot;-e&quot;, _))
  os.proc(&quot;jar&quot;, &quot;-c&quot;, mainFlags, &quot;-f&quot;, T.dest / s&quot;assembly.jar&quot;, &quot;.&quot;)
    .call(cwd = T.dest)

  PathRef(T.dest / s&quot;assembly.jar&quot;)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code defines the following task graph, with the boxes being the tasks
and the arrows representing the <em>data-flow</em> between them:</p>
</div>
<div class="paragraph">
<center>
<svg width="280px" height="119px" viewBox="0.00 0.00 280.41 118.80" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 114.8)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-114.8 276.41,-114.8 276.41,4 -4,4"></polygon>
<!-- sources -->
<g id="node1" class="node">
<title>sources</title>
<polygon fill="white" stroke="black" points="57.97,-110.7 0.01,-110.7 0.01,-86.1 57.97,-86.1 57.97,-110.7"></polygon>
<text text-anchor="middle" x="28.99" y="-94.2" font-family="Times,serif" font-size="14.00">sources</text>
</g>
<!-- compile -->
<g id="node2" class="node">
<title>compile</title>
<polygon fill="white" stroke="black" points="161.74,-110.7 100.54,-110.7 100.54,-86.1 161.74,-86.1 161.74,-110.7"></polygon>
<text text-anchor="middle" x="131.14" y="-94.2" font-family="Times,serif" font-size="14.00">compile</text>
</g>
<!-- sources&#45;&gt;compile -->
<g id="edge1" class="edge">
<title>sources-&gt;compile</title>
<path fill="none" stroke="black" d="M58.15,-98.4C68.15,-98.4 79.6,-98.4 90.38,-98.4"></path>
<polygon fill="black" stroke="black" points="90.44,-101.9 100.44,-98.4 90.44,-94.9 90.44,-101.9"></polygon>
</g>
<!-- assembly -->
<g id="node3" class="node">
<title>assembly</title>
<polygon fill="white" stroke="black" points="272.46,-67.7 204.26,-67.7 204.26,-43.1 272.46,-43.1 272.46,-67.7"></polygon>
<text text-anchor="middle" x="238.36" y="-51.2" font-family="Times,serif" font-size="14.00">assembly</text>
</g>
<!-- compile&#45;&gt;assembly -->
<g id="edge2" class="edge">
<title>compile-&gt;assembly</title>
<path fill="none" stroke="black" d="M161.73,-86.31C172.86,-81.76 185.69,-76.51 197.6,-71.65"></path>
<polygon fill="black" stroke="black" points="198.96,-74.87 206.89,-67.85 196.31,-68.39 198.96,-74.87"></polygon>
</g>
<!-- resources -->
<g id="node4" class="node">
<title>resources</title>
<polygon fill="white" stroke="black" points="165.5,-67.7 96.79,-67.7 96.79,-43.1 165.5,-43.1 165.5,-67.7"></polygon>
<text text-anchor="middle" x="131.14" y="-51.2" font-family="Times,serif" font-size="14.00">resources</text>
</g>
<!-- resources&#45;&gt;assembly -->
<g id="edge3" class="edge">
<title>resources-&gt;assembly</title>
<path fill="none" stroke="black" d="M165.72,-55.4C174.73,-55.4 184.6,-55.4 194.06,-55.4"></path>
<polygon fill="black" stroke="black" points="194.09,-58.9 204.09,-55.4 194.09,-51.9 194.09,-58.9"></polygon>
</g>
<!-- mainClass -->
<g id="node5" class="node">
<title>mainClass</title>
<polygon fill="white" stroke="black" points="168.47,-24.7 93.81,-24.7 93.81,-0.1 168.47,-0.1 168.47,-24.7"></polygon>
<text text-anchor="middle" x="131.14" y="-8.2" font-family="Times,serif" font-size="14.00">mainClass</text>
</g>
<!-- mainClass&#45;&gt;assembly -->
<g id="edge4" class="edge">
<title>mainClass-&gt;assembly</title>
<path fill="none" stroke="black" d="M162.29,-24.72C173.3,-29.22 185.92,-34.38 197.63,-39.17"></path>
<polygon fill="black" stroke="black" points="196.62,-42.53 207.2,-43.08 199.27,-36.05 196.62,-42.53"></polygon>
</g>
</g>
</svg>

</center>
</div>
<div class="paragraph">
<p>This example does not use any of Mill’s builtin support for building Java or
Scala projects, and instead builds a pipeline &quot;from scratch&quot; using Mill
tasks and <code>javac</code>/<code>jar</code>/<code>java</code> subprocesses. We define <code>T.source</code> folders,
plain <code>T{...​}</code> targets that depend on them, and a <code>T.command</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill show assembly
&quot;.../out/assembly.dest/assembly.jar&quot;

&gt; java -jar out/assembly.dest/assembly.jar i am cow
Foo.value: 31337
args: i am cow

&gt; unzip -p out/assembly.dest/assembly.jar foo.txt
My Example Text</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you first evaluate <code>assembly</code> (e.g. via <code>mill assembly</code> at the command
line), it will evaluate all the defined targets: <code>mainClass</code>, <code>sources</code>,
<code>compile</code>, and <code>assembly</code>.</p>
</div>
<div class="paragraph">
<p>Subsequent invocations of <code>mill assembly</code> will evaluate only as much as is
necessary, depending on what input sources changed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the files in <code>sources</code> change, it will re-evaluate
<code>compile</code>, and <code>assembly</code> (red)</p>
</li>
</ul>
</div>
<div class="paragraph">
<center>
<svg width="280px" height="119px" viewBox="0.00 0.00 280.41 118.80" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 114.8)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-114.8 276.41,-114.8 276.41,4 -4,4"></polygon>
<!-- sources -->
<g id="node1" class="node">
<title>sources</title>
<polygon fill="lightpink" stroke="black" points="57.97,-110.7 0.01,-110.7 0.01,-86.1 57.97,-86.1 57.97,-110.7"></polygon>
<text text-anchor="middle" x="28.99" y="-94.2" font-family="Times,serif" font-size="14.00">sources</text>
</g>
<!-- compile -->
<g id="node2" class="node">
<title>compile</title>
<polygon fill="lightpink" stroke="black" points="161.74,-110.7 100.54,-110.7 100.54,-86.1 161.74,-86.1 161.74,-110.7"></polygon>
<text text-anchor="middle" x="131.14" y="-94.2" font-family="Times,serif" font-size="14.00">compile</text>
</g>
<!-- sources&#45;&gt;compile -->
<g id="edge1" class="edge">
<title>sources-&gt;compile</title>
<path fill="none" stroke="black" d="M58.15,-98.4C68.15,-98.4 79.6,-98.4 90.38,-98.4"></path>
<polygon fill="black" stroke="black" points="90.44,-101.9 100.44,-98.4 90.44,-94.9 90.44,-101.9"></polygon>
</g>
<!-- assembly -->
<g id="node3" class="node">
<title>assembly</title>
<polygon fill="lightpink" stroke="black" points="272.46,-67.7 204.26,-67.7 204.26,-43.1 272.46,-43.1 272.46,-67.7"></polygon>
<text text-anchor="middle" x="238.36" y="-51.2" font-family="Times,serif" font-size="14.00">assembly</text>
</g>
<!-- compile&#45;&gt;assembly -->
<g id="edge2" class="edge">
<title>compile-&gt;assembly</title>
<path fill="none" stroke="black" d="M161.73,-86.31C172.86,-81.76 185.69,-76.51 197.6,-71.65"></path>
<polygon fill="black" stroke="black" points="198.96,-74.87 206.89,-67.85 196.31,-68.39 198.96,-74.87"></polygon>
</g>
<!-- resources -->
<g id="node4" class="node">
<title>resources</title>
<polygon fill="lightgreen" stroke="black" points="165.5,-67.7 96.79,-67.7 96.79,-43.1 165.5,-43.1 165.5,-67.7"></polygon>
<text text-anchor="middle" x="131.14" y="-51.2" font-family="Times,serif" font-size="14.00">resources</text>
</g>
<!-- resources&#45;&gt;assembly -->
<g id="edge3" class="edge">
<title>resources-&gt;assembly</title>
<path fill="none" stroke="black" d="M165.72,-55.4C174.73,-55.4 184.6,-55.4 194.06,-55.4"></path>
<polygon fill="black" stroke="black" points="194.09,-58.9 204.09,-55.4 194.09,-51.9 194.09,-58.9"></polygon>
</g>
<!-- mainClass -->
<g id="node5" class="node">
<title>mainClass</title>
<polygon fill="lightgreen" stroke="black" points="168.47,-24.7 93.81,-24.7 93.81,-0.1 168.47,-0.1 168.47,-24.7"></polygon>
<text text-anchor="middle" x="131.14" y="-8.2" font-family="Times,serif" font-size="14.00">mainClass</text>
</g>
<!-- mainClass&#45;&gt;assembly -->
<g id="edge4" class="edge">
<title>mainClass-&gt;assembly</title>
<path fill="none" stroke="black" d="M162.29,-24.72C173.3,-29.22 185.92,-34.38 197.63,-39.17"></path>
<polygon fill="black" stroke="black" points="196.62,-42.53 207.2,-43.08 199.27,-36.05 196.62,-42.53"></polygon>
</g>
</g>
</svg>

</center>
</div>
<div class="ulist">
<ul>
<li>
<p>If the files in <code>resources</code> change, it will only re-evaluate <code>assembly</code> (red)
and use the cached output of <code>compile</code> (green)</p>
</li>
</ul>
</div>
<div class="paragraph">
<center>
<svg width="280px" height="119px" viewBox="0.00 0.00 280.41 118.80" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 114.8)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-114.8 276.41,-114.8 276.41,4 -4,4"></polygon>
<!-- sources -->
<g id="node1" class="node">
<title>sources</title>
<polygon fill="lightgreen" stroke="black" points="57.97,-110.7 0.01,-110.7 0.01,-86.1 57.97,-86.1 57.97,-110.7"></polygon>
<text text-anchor="middle" x="28.99" y="-94.2" font-family="Times,serif" font-size="14.00">sources</text>
</g>
<!-- compile -->
<g id="node2" class="node">
<title>compile</title>
<polygon fill="lightgreen" stroke="black" points="161.74,-110.7 100.54,-110.7 100.54,-86.1 161.74,-86.1 161.74,-110.7"></polygon>
<text text-anchor="middle" x="131.14" y="-94.2" font-family="Times,serif" font-size="14.00">compile</text>
</g>
<!-- sources&#45;&gt;compile -->
<g id="edge1" class="edge">
<title>sources-&gt;compile</title>
<path fill="none" stroke="black" d="M58.15,-98.4C68.15,-98.4 79.6,-98.4 90.38,-98.4"></path>
<polygon fill="black" stroke="black" points="90.44,-101.9 100.44,-98.4 90.44,-94.9 90.44,-101.9"></polygon>
</g>
<!-- assembly -->
<g id="node3" class="node">
<title>assembly</title>
<polygon fill="lightpink" stroke="black" points="272.46,-67.7 204.26,-67.7 204.26,-43.1 272.46,-43.1 272.46,-67.7"></polygon>
<text text-anchor="middle" x="238.36" y="-51.2" font-family="Times,serif" font-size="14.00">assembly</text>
</g>
<!-- compile&#45;&gt;assembly -->
<g id="edge2" class="edge">
<title>compile-&gt;assembly</title>
<path fill="none" stroke="black" d="M161.73,-86.31C172.86,-81.76 185.69,-76.51 197.6,-71.65"></path>
<polygon fill="black" stroke="black" points="198.96,-74.87 206.89,-67.85 196.31,-68.39 198.96,-74.87"></polygon>
</g>
<!-- resources -->
<g id="node4" class="node">
<title>resources</title>
<polygon fill="lightpink" stroke="black" points="165.5,-67.7 96.79,-67.7 96.79,-43.1 165.5,-43.1 165.5,-67.7"></polygon>
<text text-anchor="middle" x="131.14" y="-51.2" font-family="Times,serif" font-size="14.00">resources</text>
</g>
<!-- resources&#45;&gt;assembly -->
<g id="edge3" class="edge">
<title>resources-&gt;assembly</title>
<path fill="none" stroke="black" d="M165.72,-55.4C174.73,-55.4 184.6,-55.4 194.06,-55.4"></path>
<polygon fill="black" stroke="black" points="194.09,-58.9 204.09,-55.4 194.09,-51.9 194.09,-58.9"></polygon>
</g>
<!-- mainClass -->
<g id="node5" class="node">
<title>mainClass</title>
<polygon fill="lightgreen" stroke="black" points="168.47,-24.7 93.81,-24.7 93.81,-0.1 168.47,-0.1 168.47,-24.7"></polygon>
<text text-anchor="middle" x="131.14" y="-8.2" font-family="Times,serif" font-size="14.00">mainClass</text>
</g>
<!-- mainClass&#45;&gt;assembly -->
<g id="edge4" class="edge">
<title>mainClass-&gt;assembly</title>
<path fill="none" stroke="black" d="M162.29,-24.72C173.3,-29.22 185.92,-34.38 197.63,-39.17"></path>
<polygon fill="black" stroke="black" points="196.62,-42.53 207.2,-43.08 199.27,-36.05 196.62,-42.53"></polygon>
</g>
</g>
</svg>

</center>
</div>
</div>
</div>
<div class="sect1">
<h2 id="primitive-tasks"><a class="anchor" href="#primitive-tasks"></a>Primary Tasks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are three primary kinds of <em>Tasks</em> that you should care about:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_sources">Sources</a>, defined using <code>T.sources {...​}</code></p>
</li>
<li>
<p><a href="#_targets">Targets</a>, defined using <code>T {...​}</code></p>
</li>
<li>
<p><a href="#_commands">Commands</a>, defined using <code>T.command {...​}</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_sources"><a class="anchor" href="#_sources"></a>Sources</h3>
<div class="listingblock">
<div class="title">build.sc (<a href="https://github.com/com-lihaoyi/mill/releases/download/0.11.13/0.11.13-example-tasks-2-primary-tasks.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/0.11.13/example/tasks/2-primary-tasks">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">import mill.{Module, T, _}

def sources = T.source { millSourcePath / &quot;src&quot; }
def resources = T.source { millSourcePath / &quot;resources&quot; }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Source</code>s are defined using <code>T.source{...​}</code> taking one <code>os.Path</code>, or <code>T.sources{...​}</code>,
taking multiple <code>os.Path</code>s as arguments. A <code>Source</code>'s':
its build signature/<code>hashCode</code> depends not just on the path
it refers to (e.g. <code>foo/bar/baz</code>) but also the MD5 hash of the filesystem
tree under that path.</p>
</div>
<div class="paragraph">
<p><code>T.source</code> and <code>T.sources</code> are most common inputs in any Mill build:
they watch source files and folders and cause downstream targets to
re-compute if a change is detected.</p>
</div>
</div>
<div class="sect2">
<h3 id="_targets"><a class="anchor" href="#_targets"></a>Targets</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def allSources = T {
  os.walk(sources().path)
    .filter(_.ext == &quot;java&quot;)
    .map(PathRef(_))
}

def lineCount: T[Int] = T {
  println(&quot;Computing line count&quot;)
  allSources()
    .map(p =&gt; os.read.lines(p.path).size)
    .sum
}</code></pre>
</div>
</div>
<div class="paragraph">
<center>
<svg width="284px" height="33px" viewBox="0.00 0.00 283.51 32.80" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 28.8)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28.8 279.51,-28.8 279.51,4 -4,4"></polygon>
<!-- sources -->
<g id="node1" class="node">
<title>sources</title>
<polygon fill="white" stroke="white" points="57.97,-24.7 0.01,-24.7 0.01,-0.1 57.97,-0.1 57.97,-24.7"></polygon>
<text text-anchor="middle" x="28.99" y="-8.2" font-family="Times,serif" font-size="14.00">sources</text>
</g>
<!-- allSources -->
<g id="node2" class="node">
<title>allSources</title>
<polygon fill="white" stroke="black" points="168.45,-24.7 93.82,-24.7 93.82,-0.1 168.45,-0.1 168.45,-24.7"></polygon>
<text text-anchor="middle" x="131.14" y="-8.2" font-family="Times,serif" font-size="14.00">allSources</text>
</g>
<!-- sources&#45;&gt;allSources -->
<g id="edge1" class="edge">
<title>sources-&gt;allSources</title>
<path fill="none" stroke="black" d="M58.15,-12.4C66.14,-12.4 75.05,-12.4 83.8,-12.4"></path>
<polygon fill="black" stroke="black" points="83.95,-15.9 93.95,-12.4 83.95,-8.9 83.95,-15.9"></polygon>
</g>
<!-- lineCount -->
<g id="node3" class="node">
<title>lineCount</title>
<polygon fill="white" stroke="black" points="275.63,-24.7 204.18,-24.7 204.18,-0.1 275.63,-0.1 275.63,-24.7"></polygon>
<text text-anchor="middle" x="239.9" y="-8.2" font-family="Times,serif" font-size="14.00">lineCount</text>
</g>
<!-- allSources&#45;&gt;lineCount -->
<g id="edge2" class="edge">
<title>allSources-&gt;lineCount</title>
<path fill="none" stroke="black" d="M168.58,-12.4C176.74,-12.4 185.49,-12.4 193.95,-12.4"></path>
<polygon fill="black" stroke="black" points="194.06,-15.9 204.06,-12.4 194.06,-8.9 194.06,-15.9"></polygon>
</g>
</g>
</svg>

</center>
</div>
<div class="paragraph">
<p><code>Target</code>s are defined using the <code>def foo = T {...​}</code> syntax, and dependencies
on other targets are defined using <code>foo()</code> to extract the value from them.
Apart from the <code>foo()</code> calls, the <code>T {...​}</code> block contains arbitrary code that
does some work and returns a result.</p>
</div>
<div class="paragraph">
<p>If a target’s inputs change but its output does not, e.g. someone changes a
comment within the source files that doesn’t affect the classfiles, then
downstream targets do not re-evaluate. This is determined using the
<code>.hashCode</code> of the Target’s return value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill show lineCount
Computing line count
16

&gt; ./mill show lineCount # line count already cached, doesn't need to be computed
16</code></pre>
</div>
</div>
<div class="paragraph">
<p>The return-value of targets has to be JSON-serializable via
<a href="https://github.com/com-lihaoyi/upickle">uPickle</a>. You can run targets directly from the command
line, or use <code>show</code> if you want to see the JSON content or pipe it to
external tools.</p>
</div>
<div class="paragraph">
<p>Each target, e.g. <code>classFiles</code>, is assigned a <a href="https://mill-build.org/api/latest/mill/api/Ctx.html#dest:os.Path">T.dest</a>
folder e.g. <code>out/classFiles.dest/</code> on disk as scratch space &amp; to store its
output files , and its returned metadata is automatically JSON-serialized
and stored at <code>out/classFiles.json</code>. If you want to return a file or a set
of files as the result of a <code>Target</code>, write them to disk within your <code>T.dest</code>
folder and return a <code>PathRef()</code> that referencing the files or folders
you want to return:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def classFiles = T {
  println(&quot;Generating classfiles&quot;)

  os.proc(&quot;javac&quot;, allSources().map(_.path), &quot;-d&quot;, T.dest)
    .call(cwd = T.dest)

  PathRef(T.dest)
}

def jar = T {
  println(&quot;Generating jar&quot;)
  os.copy(classFiles().path, T.dest, mergeFolders = true)
  os.copy(resources().path, T.dest, mergeFolders = true)

  os.proc(&quot;jar&quot;, &quot;-cfe&quot;, T.dest / &quot;foo.jar&quot;, &quot;foo.Foo&quot;, &quot;.&quot;).call(cwd = T.dest)

  PathRef(T.dest / &quot;foo.jar&quot;)
}</code></pre>
</div>
</div>
<div class="paragraph">
<center>
<svg width="256px" height="76px" viewBox="0.00 0.00 255.51 75.80" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 71.8)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-71.8 251.51,-71.8 251.51,4 -4,4"></polygon>
<!-- allSources -->
<g id="node1" class="node">
<title>allSources</title>
<polygon fill="white" stroke="white" points="74.47,-67.7 -0.16,-67.7 -0.16,-43.1 74.47,-43.1 74.47,-67.7"></polygon>
<text text-anchor="middle" x="37.16" y="-51.2" font-family="Times,serif" font-size="14.00">allSources</text>
</g>
<!-- classFiles -->
<g id="node2" class="node">
<title>classFiles</title>
<polygon fill="white" stroke="black" points="180.96,-67.7 110.1,-67.7 110.1,-43.1 180.96,-43.1 180.96,-67.7"></polygon>
<text text-anchor="middle" x="145.53" y="-51.2" font-family="Times,serif" font-size="14.00">classFiles</text>
</g>
<!-- allSources&#45;&gt;classFiles -->
<g id="edge1" class="edge">
<title>allSources-&gt;classFiles</title>
<path fill="none" stroke="black" d="M74.47,-55.4C82.68,-55.4 91.5,-55.4 100.01,-55.4"></path>
<polygon fill="black" stroke="black" points="100.18,-58.9 110.18,-55.4 100.18,-51.9 100.18,-58.9"></polygon>
</g>
<!-- jar -->
<g id="node3" class="node">
<title>jar</title>
<polygon fill="white" stroke="black" points="247.39,-45.7 216.86,-45.7 216.86,-21.1 247.39,-21.1 247.39,-45.7"></polygon>
<text text-anchor="middle" x="232.13" y="-29.2" font-family="Times,serif" font-size="14.00">jar</text>
</g>
<!-- classFiles&#45;&gt;jar -->
<g id="edge2" class="edge">
<title>classFiles-&gt;jar</title>
<path fill="none" stroke="black" d="M180.94,-46.45C189.59,-44.2 198.7,-41.83 206.75,-39.74"></path>
<polygon fill="black" stroke="black" points="207.79,-43.09 216.58,-37.18 206.03,-36.31 207.79,-43.09"></polygon>
</g>
<!-- resources -->
<g id="node4" class="node">
<title>resources</title>
<polygon fill="white" stroke="white" points="179.88,-24.7 111.17,-24.7 111.17,-0.1 179.88,-0.1 179.88,-24.7"></polygon>
<text text-anchor="middle" x="145.53" y="-8.2" font-family="Times,serif" font-size="14.00">resources</text>
</g>
<!-- resources&#45;&gt;jar -->
<g id="edge3" class="edge">
<title>resources-&gt;jar</title>
<path fill="none" stroke="black" d="M179.96,-20.7C188.93,-22.92 198.45,-25.29 206.81,-27.36"></path>
<polygon fill="black" stroke="black" points="206.11,-30.8 216.66,-29.81 207.8,-24 206.11,-30.8"></polygon>
</g>
</g>
</svg>

</center>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill jar
Generating classfiles
Generating jar

&gt; ./mill show jar
&quot;.../out/jar.dest/foo.jar&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Targets can depend on other targets via the <code>foo()</code> syntax.
The graph of inter-dependent targets is evaluated in topological order; that
means that the body of a target will not even begin to evaluate if one of its
upstream dependencies has failed. Similar, even if the upstream targets is
not used in one branch of an <code>if</code> condition, it will get computed regardless
before the <code>if</code> condition is even considered.</p>
</div>
<div class="paragraph">
<p>The following example demonstrates this behavior, with the <code>println</code> defined
in <code>def largeFile</code> running even though the <code>largeFile()</code> branch of the
<code>if</code> conditional does not get used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def largeFile = T {
  println(&quot;Finding Largest File&quot;)
  allSources()
    .map(_.path)
    .filter(_.ext == &quot;java&quot;)
    .maxBy(os.read.lines(_).size)
}

def hugeFileName = T{
  if (lineCount() &gt; 999) largeFile().last
  else &quot;&lt;no-huge-file&gt;&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<center>
<svg width="318px" height="33px" viewBox="0.00 0.00 318.49 32.80" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 28.8)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28.8 314.49,-28.8 314.49,4 -4,4"></polygon>
<!-- allSources -->
<g id="node1" class="node">
<title>allSources</title>
<polygon fill="white" stroke="white" points="74.47,-24.7 -0.16,-24.7 -0.16,-0.1 74.47,-0.1 74.47,-24.7"></polygon>
<text text-anchor="middle" x="37.16" y="-8.2" font-family="Times,serif" font-size="14.00">allSources</text>
</g>
<!-- largeFile -->
<g id="node2" class="node">
<title>largeFile</title>
<polygon fill="white" stroke="black" points="175.95,-24.7 110.43,-24.7 110.43,-0.1 175.95,-0.1 175.95,-24.7"></polygon>
<text text-anchor="middle" x="143.19" y="-8.2" font-family="Times,serif" font-size="14.00">largeFile</text>
</g>
<!-- allSources&#45;&gt;largeFile -->
<g id="edge1" class="edge">
<title>allSources-&gt;largeFile</title>
<path fill="none" stroke="black" d="M74.54,-12.4C82.79,-12.4 91.62,-12.4 100.08,-12.4"></path>
<polygon fill="black" stroke="black" points="100.16,-15.9 110.16,-12.4 100.16,-8.9 100.16,-15.9"></polygon>
</g>
<!-- hugeFileName -->
<g id="node3" class="node">
<title>hugeFileName</title>
<polygon fill="white" stroke="black" points="310.7,-24.7 211.86,-24.7 211.86,-0.1 310.7,-0.1 310.7,-24.7"></polygon>
<text text-anchor="middle" x="261.28" y="-8.2" font-family="Times,serif" font-size="14.00">hugeFileName</text>
</g>
<!-- largeFile&#45;&gt;hugeFileName -->
<g id="edge2" class="edge">
<title>largeFile-&gt;hugeFileName</title>
<path fill="none" stroke="black" d="M176.22,-12.4C184.13,-12.4 192.86,-12.4 201.6,-12.4"></path>
<polygon fill="black" stroke="black" points="201.82,-15.9 211.82,-12.4 201.82,-8.9 201.82,-15.9"></polygon>
</g>
</g>
</svg>

</center>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill show lineCount
16

&gt; ./mill show hugeFileName # This still runs `largestFile` even though `lineCount() &lt; 999`
Finding Largest File
&quot;&lt;no-huge-file&gt;&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>uPickle comes with built-in support for most Scala primitive types and
builtin data structures: tuples, collections, <code>PathRef</code>s, etc. can be
returned and automatically serialized/de-serialized as necessary. One
notable exception is <code>case class</code>es: if you want return your own
<code>case class</code>, you must mark it JSON-serializable by adding the following
<code>implicit</code> to its companion object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">case class ClassFileData(totalFileSize: Long, largestFile: String)
object ClassFileData {
  implicit val rw: upickle.default.ReadWriter[ClassFileData] = upickle.default.macroRW
}

def summarizeClassFileStats = T{
  val files = os.walk(classFiles().path)
  ClassFileData(
    totalFileSize = files.map(os.size(_)).sum,
    largestFile = files.maxBy(os.size(_)).last
  )
}</code></pre>
</div>
</div>
<div class="paragraph">
<center>
<svg width="278px" height="33px" viewBox="0.00 0.00 278.19 32.80" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 28.8)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28.8 274.19,-28.8 274.19,4 -4,4"></polygon>
<!-- classFiles -->
<g id="node1" class="node">
<title>classFiles</title>
<polygon fill="white" stroke="white" points="70.65,-24.7 -0.22,-24.7 -0.22,-0.1 70.65,-0.1 70.65,-24.7"></polygon>
<text text-anchor="middle" x="35.22" y="-8.2" font-family="Times,serif" font-size="14.00">classFiles</text>
</g>
<!-- summarizedClassFileStats -->
<g id="node2" class="node">
<title>summarizedClassFileStats</title>
<polygon fill="white" stroke="black" points="270.06,-24.7 106.56,-24.7 106.56,-0.1 270.06,-0.1 270.06,-24.7"></polygon>
<text text-anchor="middle" x="188.31" y="-8.2" font-family="Times,serif" font-size="14.00">summarizedClassFileStats</text>
</g>
<!-- classFiles&#45;&gt;summarizedClassFileStats -->
<g id="edge1" class="edge">
<title>classFiles-&gt;summarizedClassFileStats</title>
<path fill="none" stroke="black" d="M70.5,-12.4C78.35,-12.4 87.05,-12.4 96.06,-12.4"></path>
<polygon fill="black" stroke="black" points="96.34,-15.9 106.34,-12.4 96.34,-8.9 96.34,-15.9"></polygon>
</g>
</g>
</svg>

</center>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill show summarizeClassFileStats
{
  &quot;totalFileSize&quot;: ...,
  &quot;largestFile&quot;: &quot;...&quot;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_commands"><a class="anchor" href="#_commands"></a>Commands</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def run(args: String*) = T.command {
  os.proc(
      &quot;java&quot;,
      &quot;-cp&quot;, s&quot;${classFiles().path}:${resources().path}&quot;,
      &quot;foo.Foo&quot;,
      args
    )
    .call(stdout = os.Inherit)
}</code></pre>
</div>
</div>
<div class="paragraph">
<center>
<svg width="149px" height="76px" viewBox="0.00 0.00 149.09 75.80" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 71.8)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-71.8 145.09,-71.8 145.09,4 -4,4"></polygon>
<!-- classFiles -->
<g id="node1" class="node">
<title>classFiles</title>
<polygon fill="white" stroke="white" points="70.65,-67.7 -0.22,-67.7 -0.22,-43.1 70.65,-43.1 70.65,-67.7"></polygon>
<text text-anchor="middle" x="35.22" y="-51.2" font-family="Times,serif" font-size="14.00">classFiles</text>
</g>
<!-- run -->
<g id="node2" class="node">
<title>run</title>
<polygon fill="white" stroke="black" points="140.92,-45.7 106.6,-45.7 106.6,-21.1 140.92,-21.1 140.92,-45.7"></polygon>
<text text-anchor="middle" x="123.76" y="-29.2" font-family="Times,serif" font-size="14.00">run</text>
</g>
<!-- classFiles&#45;&gt;run -->
<g id="edge1" class="edge">
<title>classFiles-&gt;run</title>
<path fill="none" stroke="black" d="M70.92,-46.58C79.42,-44.42 88.38,-42.14 96.42,-40.1"></path>
<polygon fill="black" stroke="black" points="97.5,-43.43 106.33,-37.58 95.78,-36.65 97.5,-43.43"></polygon>
</g>
<!-- resources -->
<g id="node3" class="node">
<title>resources</title>
<polygon fill="white" stroke="white" points="69.57,-24.7 0.86,-24.7 0.86,-0.1 69.57,-0.1 69.57,-24.7"></polygon>
<text text-anchor="middle" x="35.22" y="-8.2" font-family="Times,serif" font-size="14.00">resources</text>
</g>
<!-- resources&#45;&gt;run -->
<g id="edge2" class="edge">
<title>resources-&gt;run</title>
<path fill="none" stroke="black" d="M69.92,-20.58C78.74,-22.72 88.1,-24.99 96.46,-27.02"></path>
<polygon fill="black" stroke="black" points="95.86,-30.47 106.4,-29.43 97.51,-23.67 95.86,-30.47"></polygon>
</g>
</g>
</svg>

</center>
</div>
<div class="paragraph">
<p>Defined using <code>T.command {...​}</code> syntax, <code>Command</code>s can run arbitrary code, with
dependencies declared using the same <code>foo()</code> syntax (e.g. <code>classFiles()</code> above).
Commands can be parametrized, but their output is not cached, so they will
re-evaluate every time even if none of their inputs have changed.
A command with no parameter is defined as <code>def myCommand() = T.command {...​}</code>.
It is a compile error if <code>()</code> is missing.</p>
</div>
<div class="paragraph">
<p>Like <a href="#_targets">Targets</a>, a command only evaluates after all its upstream
dependencies have completed, and will not begin to run if any upstream
dependency has failed.</p>
</div>
<div class="paragraph">
<p>Commands are assigned the same scratch/output folder <code>out/run.dest/</code> as
Targets are, and its returned metadata stored at the same <code>out/run.json</code>
path for consumption by external tools.</p>
</div>
<div class="paragraph">
<p>Commands can only be defined directly within a <code>Module</code> body.</p>
</div>
</div>
<div class="sect2">
<h3 id="_overrides"><a class="anchor" href="#_overrides"></a>Overrides</h3>
<div class="paragraph">
<p>Targets and sources can be overriden, with the override task callable via <code>super</code>.
This lets you override-and-extend source lists the same way you would any other target
definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">trait Foo extends Module {
  def sourceRoots = T.sources(millSourcePath / &quot;src&quot;)
  def sourceContents = T{
    sourceRoots()
      .flatMap(pref =&gt; os.walk(pref.path))
      .filter(_.ext == &quot;txt&quot;)
      .sorted
      .map(os.read(_))
  }
}

trait Bar extends Foo {
  def additionalSources = T.sources(millSourcePath / &quot;src2&quot;)
  def sourceRoots = T { super.sourceRoots() ++ additionalSources() }
}

object bar extends Bar</code></pre>
</div>
</div>
<div class="paragraph">
<center>
<svg width="451px" height="76px" viewBox="0.00 0.00 450.67 75.80" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 71.8)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-71.8 446.67,-71.8 446.67,4 -4,4"></polygon>
<!-- bar.sourceRoots.super -->
<g id="node1" class="node">
<title>bar.sourceRoots.super</title>
<polygon fill="white" stroke="black" points="140.6,-67.7 -0.2,-67.7 -0.2,-43.1 140.6,-43.1 140.6,-67.7"></polygon>
<text text-anchor="middle" x="70.2" y="-51.2" font-family="Times,serif" font-size="14.00">bar.sourceRoots.super</text>
</g>
<!-- bar.sourceRoots -->
<g id="node2" class="node">
<title>bar.sourceRoots</title>
<polygon fill="white" stroke="black" points="282.77,-45.7 176.61,-45.7 176.61,-21.1 282.77,-21.1 282.77,-45.7"></polygon>
<text text-anchor="middle" x="229.69" y="-29.2" font-family="Times,serif" font-size="14.00">bar.sourceRoots</text>
</g>
<!-- bar.sourceRoots.super&#45;&gt;bar.sourceRoots -->
<g id="edge1" class="edge">
<title>bar.sourceRoots.super-&gt;bar.sourceRoots</title>
<path fill="none" stroke="black" d="M140.74,-45.69C149.29,-44.49 157.99,-43.28 166.43,-42.1"></path>
<polygon fill="black" stroke="black" points="167.14,-45.53 176.56,-40.68 166.17,-38.6 167.14,-45.53"></polygon>
</g>
<!-- bar.sourceContents -->
<g id="node3" class="node">
<title>bar.sourceContents</title>
<polygon fill="white" stroke="black" points="442.51,-45.7 319.14,-45.7 319.14,-21.1 442.51,-21.1 442.51,-45.7"></polygon>
<text text-anchor="middle" x="380.83" y="-29.2" font-family="Times,serif" font-size="14.00">bar.sourceContents</text>
</g>
<!-- bar.sourceRoots&#45;&gt;bar.sourceContents -->
<g id="edge2" class="edge">
<title>bar.sourceRoots-&gt;bar.sourceContents</title>
<path fill="none" stroke="black" d="M282.85,-33.4C291.24,-33.4 300.05,-33.4 308.8,-33.4"></path>
<polygon fill="black" stroke="black" points="309,-36.9 319,-33.4 309,-29.9 309,-36.9"></polygon>
</g>
<!-- bar.additionalSources -->
<g id="node4" class="node">
<title>bar.additionalSources</title>
<polygon fill="white" stroke="black" points="138.88,-24.7 1.52,-24.7 1.52,-0.1 138.88,-0.1 138.88,-24.7"></polygon>
<text text-anchor="middle" x="70.2" y="-8.2" font-family="Times,serif" font-size="14.00">bar.additionalSources</text>
</g>
<!-- bar.additionalSources&#45;&gt;bar.sourceRoots -->
<g id="edge3" class="edge">
<title>bar.additionalSources-&gt;bar.sourceRoots</title>
<path fill="none" stroke="black" d="M138.91,-21.43C147.99,-22.64 157.28,-23.88 166.27,-25.08"></path>
<polygon fill="black" stroke="black" points="165.89,-28.56 176.26,-26.41 166.81,-21.62 165.89,-28.56"></polygon>
</g>
</g>
</svg>

</center>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill show bar.sourceContents # includes both source folders
[
  &quot;File Data From src/&quot;,
  &quot;File Data From src2/&quot;
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_tasks"><a class="anchor" href="#_other_tasks"></a>Other Tasks</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="#_anonymous_tasks">Anonymous Tasks</a>, defined using <code>T.task {...​}</code></p>
</li>
<li>
<p><a href="#_persistent_targets">Persistent Targets</a></p>
</li>
<li>
<p><a href="#_inputs">Inputs</a></p>
</li>
<li>
<p><a href="#_workers">Workers</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_anonymous_tasks"><a class="anchor" href="#_anonymous_tasks"></a>Anonymous Tasks</h3>
<div class="listingblock">
<div class="title">build.sc (<a href="https://github.com/com-lihaoyi/mill/releases/download/0.11.13/0.11.13-example-tasks-3-anonymous-tasks.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/0.11.13/example/tasks/3-anonymous-tasks">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">import mill._, define.Task

def data = T.source(millSourcePath / &quot;data&quot;)

def anonTask(fileName: String): Task[String] = T.task {
  os.read(data().path / fileName)
}

def helloFileData = T { anonTask(&quot;hello.txt&quot;)() }
def printFileData(fileName: String) = T.command {
  println(anonTask(fileName)())
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can define anonymous tasks using the <code>T.task {...​}</code> syntax. These are
not runnable from the command-line, but can be used to share common code you
find yourself repeating in <code>Target</code>s and <code>Command</code>s.</p>
</div>
<div class="paragraph">
<p>Anonymous task’s output does not need to be JSON-serializable, their output is
not cached, and they can be defined with or without arguments.
Unlike <a href="#_targets">Targets</a> or <a href="#_commands">Commands</a>, anonymous tasks can be defined
anywhere and passed around any way you want, until you finally make use of them
within a downstream target or command.</p>
</div>
<div class="paragraph">
<p>While an anonymous task <code>foo</code>'s own output is not cached, if it is used in a
downstream target <code>baz</code> and the upstream target <code>bar</code> hasn’t changed,
<code>baz</code>'s cached output will be used and <code>foo</code>'s evaluation will be skipped
altogether.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill show helloFileData
&quot;Hello&quot;

&gt; ./mill printFileData hello.txt
Hello

&gt; ./mill printFileData world.txt
World!</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inputs"><a class="anchor" href="#_inputs"></a>Inputs</h3>
<div class="listingblock">
<div class="title">build.sc (<a href="https://github.com/com-lihaoyi/mill/releases/download/0.11.13/0.11.13-example-tasks-4-inputs.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/0.11.13/example/tasks/4-inputs">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">import mill._

def myInput = T.input {
  os.proc(&quot;git&quot;, &quot;rev-parse&quot;, &quot;HEAD&quot;).call(cwd = T.workspace)
    .out
    .text()
    .trim()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A generalization of <a href="#_sources">Sources</a>, <code>T.input</code>s are tasks that re-evaluate
<em>every time</em> (unlike <a href="#_anonymous_tasks">Anonymous Tasks</a>), containing an
arbitrary block of code.</p>
</div>
<div class="paragraph">
<p>Inputs can be used to force re-evaluation of some external property that may
affect your build. For example, if I have a <a href="#_targets">Target</a> <code>bar</code> that
calls out to <code>git</code> to compute the latest commit hash and message directly,
that target does not have any <code>Task</code> inputs and so will never re-compute
even if the external <code>git</code> status changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def gitStatusTask = T {
  &quot;version-&quot; +
    os.proc(&quot;git&quot;, &quot;log&quot;, &quot;-1&quot;, &quot;--pretty=format:%h-%B &quot;)
      .call(cwd = T.workspace)
      .out
      .text()
      .trim()
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; git init .
&gt; git commit --no-gpg-sign --allow-empty -m &quot;Initial-Commit&quot;

&gt; ./mill show gitStatusTask
&quot;version-...-Initial-Commit&quot;

&gt; git commit --no-gpg-sign --allow-empty -m &quot;Second-Commit&quot;

&gt; ./mill show gitStatusTask # Mill didn't pick up the git change!
&quot;version-...-Initial-Commit&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>gitStatusTask</code> will not know that <code>git rev-parse</code> can change, and will
not know to re-evaluate when your <code>git log</code> <em>does</em> change. This means
<code>gitStatusTask</code> will continue to use any previously cached value, and
<code>gitStatusTask</code>'s output will  be out of date!</p>
</div>
<div class="paragraph">
<p>To fix this, you can wrap your <code>git log</code> in a <code>T.input</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def gitStatusInput = T.input {
  os.proc(&quot;git&quot;, &quot;log&quot;, &quot;-1&quot;, &quot;--pretty=format:%h-%B &quot;)
    .call(cwd = T.workspace)
    .out
    .text()
    .trim()
}
def gitStatusTask2 = T { &quot;version-&quot; + gitStatusInput() }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This makes <code>gitStatusInput</code> to always re-evaluate every build, and only if
the output of <code>gitStatusInput</code> changes will <code>gitStatusTask2</code> re-compute</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; git commit --no-gpg-sign --allow-empty -m &quot;Initial-Commit&quot;

&gt; ./mill show gitStatusTask2
&quot;version-...-Initial-Commit&quot;

&gt; git commit --no-gpg-sign --allow-empty -m &quot;Second-Commit&quot;

&gt; ./mill show gitStatusTask2 # Mill picked up git change
&quot;version-...-Second-Commit&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that because <code>T.input</code>s re-evaluate every time, you should ensure that the
code you put in <code>T.input</code> runs quickly. Ideally it should just be a simple check
&quot;did anything change?&quot; and any heavy-lifting should be delegated to downstream
tasks where it can be cached if possible.</p>
</div>
</div>
<div class="sect2">
<h3 id="_system_properties_inputs"><a class="anchor" href="#_system_properties_inputs"></a>System Properties Inputs</h3>
<div class="paragraph">
<p>One major use case of <code>Input</code> tasks is to make your build configurable via
JVM system properties of environment variables. If you directly access
<code>sys.props</code> or <code>sys.env</code> inside a <a href="#_cached_tasks">cached Task{}</a>, the
cached value will be used even if the property or environment variable changes
in subsequent runs, when you really want it to be re-evaluated. Thus, accessing
system properties should be done in a <code>T.input</code>, and usage of the property
should be done downstream in a <a href="#_cached_tasks">cached task</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def myPropertyInput = T.input {
  sys.props(&quot;my-property&quot;)
}
def myPropertyTask = T {
  &quot;Hello Prop &quot; + myPropertyInput()
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill show myPropertyTask
&quot;Hello Prop null&quot;

&gt; ./mill -Dmy-property=world show myPropertyTask # Task is correctly invalidated when prop is added
&quot;Hello Prop world&quot;

&gt; ./mill show myPropertyTask # Task is correctly invalidated when prop is removed
&quot;Hello Prop null&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, <code>T.input</code> runs every time, and thus you should only do the bare minimum
in your <code>T.input</code> that is necessary to detect changes. Any further processing
should be done in downstreak <a href="#_cached_tasks">cached tasks</a> to allow for proper
caching and re-use</p>
</div>
</div>
<div class="sect2">
<h3 id="_environment_variable_inputs"><a class="anchor" href="#_environment_variable_inputs"></a>Environment Variable Inputs</h3>
<div class="paragraph">
<p>Like system properties, environment variables should be referenced in <code>T.input`s. Unlike
system properties, you need to use the special API `T.env</code> to access the environment,
due to JVM limitations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def myEnvInput = T.input {
  T.env.getOrElse(&quot;MY_ENV&quot;, null)
}

def myEnvTask = T {
  &quot;Hello Env &quot; + myEnvInput()
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill show myEnvTask
&quot;Hello Env null&quot;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">&gt; ./mill show myEnvTask # Task is correctly invalidated when env is removed
&quot;Hello Env null&quot;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_persistent_targets"><a class="anchor" href="#_persistent_targets"></a>Persistent Targets</h3>
<div class="paragraph">
<p>Persistent targets defined using <code>T.persistent</code> are similar to normal
<code>Target</code>s, except their <code>T.dest</code> folder is not cleared before every
evaluation. This makes them useful for caching things on disk in a more
fine-grained manner than Mill’s own Target-level caching.</p>
</div>
<div class="paragraph">
<p>Below is a semi-realistic example of using a <code>T.persistent</code> target:</p>
</div>
<div class="listingblock">
<div class="title">build.sc (<a href="https://github.com/com-lihaoyi/mill/releases/download/0.11.13/0.11.13-example-tasks-5-persistent-targets.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/0.11.13/example/tasks/5-persistent-targets">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">import mill._, scalalib._
import java.util.Arrays
import java.io.ByteArrayOutputStream
import java.util.zip.GZIPOutputStream

def data = T.source(millSourcePath / &quot;data&quot;)

def compressedData = T.persistent{
  println(&quot;Evaluating compressedData&quot;)
  os.makeDir.all(T.dest / &quot;cache&quot;)
  os.remove.all(T.dest / &quot;compressed&quot;)

  for(p &lt;- os.list(data().path)){
    val compressedPath = T.dest / &quot;compressed&quot; / s&quot;${p.last}.gz&quot;
    val bytes = os.read.bytes(p)
    val hash = Arrays.hashCode(bytes)
    val cachedPath = T.dest / &quot;cache&quot; / hash.toHexString
    if (!os.exists(cachedPath)) {
      println(&quot;Compressing: &quot; + p.last)
      os.write(cachedPath, compressBytes(bytes))
    } else {
      println(&quot;Reading Cached from disk: &quot; + p.last)
    }
    os.copy(cachedPath, compressedPath, createFolders = true)
  }

  os.list(T.dest / &quot;compressed&quot;).map(PathRef(_))
}

def compressBytes(input: Array[Byte]) = {
  val bos = new ByteArrayOutputStream(input.length)
  val gzip = new GZIPOutputStream(bos)
  gzip.write(input)
  gzip.close()
  bos.toByteArray
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we implement a <code>compressedData</code> target that takes a folder
of files in <code>inputData</code> and compresses them, while maintaining a cache of
compressed contents for each file. That means that if the <code>inputData</code> folder
is modified, but some files remain unchanged, those files would not be
unnecessarily re-compressed when <code>compressedData</code> evaluates.</p>
</div>
<div class="paragraph">
<p>Since persistent targets have long-lived state on disk that lives beyond a
single evaluation, this raises the possibility of the disk contents getting
into a bad state and causing all future evaluations to fail. It is left up
to the person implementing the <code>T.persistent</code> to ensure their implementation
is eventually consistent. You can also use <code>mill clean</code> to manually purge
the disk contents to start fresh.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill show compressedData
Evaluating compressedData
Compressing: hello.txt
Compressing: world.txt
[
  &quot;.../hello.txt.gz&quot;,
  &quot;.../world.txt.gz&quot;
]

&gt; ./mill compressedData # when no input changes, compressedData does not evaluate at all

&gt; sed -i 's/Hello/HELLO/g' data/hello.txt

&gt; ./mill compressedData # when one input file changes, only that file is re-compressed
Compressing: hello.txt
Reading Cached from disk: world.txt

&gt; ./mill clean compressedData

&gt; ./mill compressedData
Evaluating compressedData
Compressing: hello.txt
Compressing: world.txt</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_workers"><a class="anchor" href="#_workers"></a>Workers</h3>
<div class="paragraph">
<p>Mill workers defined using <code>T.worker</code> are long-lived in-memory objects that
can persistent across multiple evaluations. These are similar to persistent
targets in that they let you cache things, but the fact that they let you
cache the worker object in-memory allows for greater performance and
flexibility: you are no longer limited to caching only serializable data
and paying the cost of serializing it to disk every evaluation. This example
uses a Worker to provide simple in-memory caching for compressed files.</p>
</div>
<div class="listingblock">
<div class="title">build.sc (<a href="https://github.com/com-lihaoyi/mill/releases/download/0.11.13/0.11.13-example-tasks-6-workers.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/0.11.13/example/tasks/6-workers">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">import mill._, scalalib._
import java.util.Arrays
import java.io.ByteArrayOutputStream
import java.util.zip.GZIPOutputStream

def data = T.source(millSourcePath / &quot;data&quot;)

def compressWorker = T.worker{ new CompressWorker(T.dest) }

def compressedData = T{
  println(&quot;Evaluating compressedData&quot;)
  for(p &lt;- os.list(data().path)){
    os.write(
      T.dest / s&quot;${p.last}.gz&quot;,
      compressWorker().compress(p.last, os.read.bytes(p))
    )
  }
  os.list(T.dest).map(PathRef(_))
}

class CompressWorker(dest: os.Path){
  val cache = collection.mutable.Map.empty[Int, Array[Byte]]
  def compress(name: String, bytes: Array[Byte]): Array[Byte] = {
    val hash = Arrays.hashCode(bytes)
    if (!cache.contains(hash)) {
      val cachedPath = dest / hash.toHexString
      if (!os.exists(cachedPath)) {
        println(&quot;Compressing: &quot; + name)
        cache(hash) = compressBytes(bytes)
        os.write(cachedPath, cache(hash))
      }else{
        println(&quot;Cached from disk: &quot; + name)
        cache(hash) = os.read.bytes(cachedPath)
      }
    }else {
      println(&quot;Cached from memory: &quot; + name)
    }
    cache(hash)
  }
}

def compressBytes(input: Array[Byte]) = {
  val bos = new ByteArrayOutputStream(input.length)
  val gzip = new GZIPOutputStream(bos)
  gzip.write(input)
  gzip.close()
  bos.toByteArray
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Common things to put in workers include:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>References to third-party daemon processes, e.g. Webpack or wkhtmltopdf,
which perform their own in-memory caching</p>
</li>
<li>
<p>Classloaders containing plugin code, to avoid classpath conflicts while
also avoiding classloading cost every time the code is executed</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Workers live as long as the Mill process. By default, consecutive <code>mill</code>
commands in the same folder will re-use the same Mill process and workers,
unless <code>--no-server</code> is passed which will terminate the Mill process and
workers after every command. Commands run repeatedly using <code>--watch</code> will
also preserve the workers between them.</p>
</div>
<div class="paragraph">
<p>Workers can also make use of their <code>T.dest</code> folder as a cache that persist
when the worker shuts down, as a second layer of caching. The example usage
below demonstrates how using the <code>--no-server</code> flag will make the worker
read from its disk cache, where it would have normally read from its
in-memory cache</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill show compressedData
Evaluating compressedData
Compressing: hello.txt
Compressing: world.txt
[
  &quot;.../hello.txt.gz&quot;,
  &quot;...world.txt.gz&quot;
]

&gt; ./mill compressedData # when no input changes, compressedData does not evaluate at all

&gt; sed -i 's/Hello/HELLO/g' data/hello.txt

&gt; ./mill compressedData # not --no-server, we read the data from memory
Compressing: hello.txt
Cached from memory: world.txt

&gt; ./mill compressedData # --no-server, we read the data from disk
Compressing: hello.txt
Cached from disk: world.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mill uses workers to manage long-lived instances of the
<a href="https://github.com/sbt/zinc">Zinc Incremental Scala Compiler</a> and the
<a href="https://github.com/scala-js/scala-js">Scala.js Optimizer</a>.
This lets us keep them in-memory with warm caches and fast incremental execution.</p>
</div>
</div>
<div class="sect2">
<h3 id="_autoclosable_workers"><a class="anchor" href="#_autoclosable_workers"></a><code>Autoclosable</code> Workers</h3>
<div class="paragraph">
<p>As <a href="#_workers">Workers</a> may also hold limited resources, it may be necessary to free up these resources once a worker is no longer needed.
This is especially the case, when your worker tasks depends on other tasks and these tasks change, as Mill will then also create a new worker instance.</p>
</div>
<div class="paragraph">
<p>To implement resource cleanup, your worker can implement <code>java.lang.AutoCloseable</code>.
Once the worker is no longer needed, Mill will call the <code>close()</code> method on it before any newer version of this worker is created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">import mill._
import java.lang.AutoCloseable

class MyWorker() extends AutoCloseable {
  // ...
  override def close() = { /* cleanup and free resources */ }
}

def myWorker = T.worker { new MyWorker() }</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="Out_Dir.html">The Output Directory</a></span>
  <span class="next"><a href="Modules.html">Modules</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async="async" src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async="async" src="../../search-index.js"></script>
  
</body></html>