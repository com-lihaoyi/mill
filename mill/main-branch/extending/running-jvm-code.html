<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Running Dynamic JVM Code :: The Mill Build Tool</title>
    <link rel="canonical" href="https://mill-build.org/mill/extending/running-jvm-code.html" />
    <link rel="prev" href="thirdparty-plugins.html" />
    <link rel="next" href="writing-plugins.html" />
    <meta name="generator" content="Antora 3.1.12" />
    <link rel="stylesheet" href="../../../_/css/site.css" />
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-1C582ZJR85"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-1C582ZJR85')</script>
<link rel="icon" href="../../../_/favicon.png" type="image/x-icon" />
  
  <style>
  /* auto-hyphenation is super ugly */
  *{
    hyphens: manual !important;
  }

  /* Reduce font size from 17px to something reasonable */
  .doc {
   font-size: 16px !important;
  }
  .doc pre {
   font-size: 14px !important;
  }
  /* Shrink unreasonably large top bar */
  nav.navbar{
    height: 2.5rem;
  }
  body.article{
    padding-top: 2.5rem;
  }
  div.nav-container{
    top: 2.5rem;
  }
  div.toolbar{
    top: 2.5rem;
  }
  aside.nav{
    top: 2.5rem;
    height: calc(100vh - 2.5rem);
  }
  </style></head><body class="article">
  
<header class="header">
  
  <script>
  gtag('config', 'AW-16649289906');

  document.addEventListener('DOMContentLoaded', function() {
  const links = document.querySelectorAll('a');
    links.forEach(link => {
      if (link.textContent.trim().toLowerCase() === 'download') {
        link.addEventListener('click', function(event) {
          console.log("download link clicked")
          gtag('event', 'conversion', {'send_to': 'AW-16649289906/rsphCKfVq8QZELKBgIM-'});
        });
      }
    });
  });
  </script>
  <nav class="navbar">
    <div class="navbar-brand">
      <!-- TODO: add mill icon -->
      <a class="navbar-item" href="https://mill-build.org"><img src="../../../_/logo-white.svg" height="20" />Â The Mill Build Tool</a>
      <div class="navbar-item search">
        <input id="search-input" type="text" placeholder="Search the docs" />
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill">GitHub</a>
        <a class="navbar-item" href="https://mill-build.org/blog/index.html">Blog</a>
        <a class="navbar-item" href="https://mill-build.org/api/latest/mill.html">API</a>
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill/issues">Issues</a>
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill/discussions">Discuss</a>


            <!--
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Documentation</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#"></a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Plugins</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
        -->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="mill" data-version="main-branch">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list">

  <li class="nav-item" data-depth="0">
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../javalib/intro.html">Building Java with Mill</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../javalib/module-config.html">Java Module Configuration</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../javalib/dependencies.html">Java Library Dependencies</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../javalib/testing.html">Testing Java Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../javalib/linting.html">Linting Java Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../javalib/publishing.html">Java Packaging &amp; Publishing</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../javalib/build-examples.html">Java Build Examples</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../javalib/web-examples.html">Java Web Project Examples</a>
  </li>
</ul>
  </li>

  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../scalalib/intro.html">Building Scala with Mill</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../scalalib/module-config.html">Scala Module Configuration</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../scalalib/dependencies.html">Scala Library Dependencies</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../scalalib/testing.html">Testing Scala Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../scalalib/linting.html">Linting Scala Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../scalalib/publishing.html">Scala Packaging &amp; Publishing</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../scalalib/build-examples.html">Scala Build Examples</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../scalalib/web-examples.html">Scala Web Project Examples</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../scalalib/native-examples.html">Scala Native Examples</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../scalalib/spark.html">Spark Examples</a>
  </li>
</ul>
  </li>

  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../kotlinlib/intro.html">Building Kotlin with Mill</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kotlinlib/module-config.html">Kotlin Module Configuration</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kotlinlib/dependencies.html">Kotlin Library Dependencies</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kotlinlib/testing.html">Testing Kotlin Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../kotlinlib/linting.html">Linting Kotlin Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../kotlinlib/publishing.html">Kotlin Packaging &amp; Publishing</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../kotlinlib/web-examples.html">Kotlin Web Project Examples</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Experimental Platform Support</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Building Android Apps</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../android/android-initial-setup.html">Android Initial Setup</a>
  </li>

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../android/ide.html">Android IDE Support</a>
  </li>

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../android/java.html">Android Java Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../android/kotlin.html">Android Kotlin Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../android/android-linting.html">Linting Android Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../android/compose-samples.html">Android Jetpack Compose</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../android/hilt-sample.html">Android Hilt Sample</a>
  </li>
</ul>
  </li>

  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../pythonlib/intro.html">Building Python with Mill</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../pythonlib/module-config.html">Python Module Configuration</a>
  </li>

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../pythonlib/dependencies.html">Python Library Dependencies</a>
  </li>

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../pythonlib/linting.html">Linting Python Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../pythonlib/testing.html">Testing Python Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../pythonlib/publishing.html">Python Packaging &amp; Publishing</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <span class="nav-text">xref:pythonlib/web-examples.adoc</span>
  </li>
</ul>
  </li>

  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../javascriptlib/intro.html">Building Javascript with Mill</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../javascriptlib/dependencies.html">Typescript Library Dependencies</a>
  </li>

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../javascriptlib/module-config.html">Typescript Module Configuration</a>
  </li>

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../javascriptlib/testing.html">Testing Typescript Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../javascriptlib/linting.html">Linting Typescript Projects</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../javascriptlib/publishing.html">Typescript Packaging &amp; Publishing</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../javascriptlib/build-examples.html">JavaScript Build Examples</a>
  </li>
</ul>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../comparisons/why-mill.html">Why Use Mill?</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../comparisons/maven.html">Case Study: Mill vs Maven</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../comparisons/gradle.html">Case Study: Mill vs Gradle</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../comparisons/sbt.html">Case Study: Mill vs <code>sbt</code></a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">The Mill CLI</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/installation-ide.html">Installation &amp; IDE Setup</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/flags.html">Mill Command-Line Flags</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/builtin-commands.html">Built-in Commands</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../cli/query-syntax.html">Task Query Syntax</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../cli/build-header.html">Build Header Config</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../migrating/migrating.html">Migrating to Mill</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../migrating/auto-migrating.html">Automated Migration Tools</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Mill Fundamentals</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../fundamentals/tasks.html">Tasks</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../fundamentals/modules.html">Modules</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../fundamentals/out-dir.html">The Output Directory</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../fundamentals/library-deps.html">Library Dependencies in Mill</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../fundamentals/cross-builds.html">Cross Builds</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../fundamentals/bundled-libraries.html">Bundled Libraries</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../fundamentals/configuring-jvm-versions.html">Configuring JVM Versions</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Extending Mill</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="import-mvn-plugins.html">Import Libraries and Plugins</a>
  </li>

  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="contrib-plugins.html">Contrib Plugins</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../contrib/artifactory.html">Artifactory</a>
  </li>

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../contrib/buildinfo.html">BuildInfo</a>
  </li>

  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../contrib/codeartifact.html">Codeartifact</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/docker.html">Docker</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/flyway.html">Flyway</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/gitlab.html">Gitlab</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/jmh.html">JMH</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/playlib.html">Play Framework</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/proguard.html">Proguard</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/scalapblib.html">ScalaPB</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/scoverage.html">Scoverage</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/sonatypecentral.html">Sonatype Central (Plugin Moved to Scalalib)</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/testng.html">TestNG</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/twirllib.html">Twirl</a>
  </li>

  <li class="nav-item is-active" data-depth="3">
    <a class="nav-link" href="../contrib/versionfile.html">Version file</a>
  </li>
</ul>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="thirdparty-plugins.html">Third-Party Plugins</a>
  </li>

  <li class="nav-item is-current-page is-active" data-depth="2">
    <a class="nav-link" href="running-jvm-code.html">Running Dynamic JVM Code</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="writing-plugins.html">Writing Mill Plugins</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="meta-build.html">The Mill Meta-Build</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="example-typescript-support.html">Example: Typescript Support</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="example-python-support.html">Example: Python Support</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../large/large.html">Large Builds and Monorepos</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../large/selective-execution.html">Selective Test Execution</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../large/multi-file-builds.html">Multi-File Builds</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../large/multi-language-builds.html">Multi-Language Builds</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Mill In Depth</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../depth/evaluation-model.html">The Mill Evaluation Model</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../depth/caching.html">Caching in Mill</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../depth/parallelism.html">Parallelism in Mill</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../depth/process-architecture.html">The Mill Process Architecture</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../depth/sandboxing.html">Mill Sandboxing</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../depth/design-principles.html">Mill Design Principles</a>
  </li>

  <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="../depth/why-scala.html">Why does Mill use Scala?</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://mill-build.org/api/latest/mill.html">Mill API Reference</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://github.com/com-lihaoyi/mill/blob/main/changelog.adoc">Changelog</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/talks-blog-posts.html">Talks &amp; Blog Posts</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Mill Documentation</span>
    <span class="version">main-branch</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../../index.html">Mill Documentation</a></div>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">main-branch</a>
        </li>
        <li class="version is-latest">
          <a href="../../index.html">1.0.4</a>
        </li>
        <li class="version">
          <a href="../../dev-1.0.4-8-28c1bd/index.html">dev-1.0.4-8-28c1bd</a>
        </li>
        <li class="version">
          <a href="../../0.12.x/index.html">0.12.14</a>
        </li>
        <li class="version">
          <a href="../../0.11.x/index.html">0.11.13</a>
        </li>
        <li class="version">
          <a href="../../0.10.15/index.html">0.10.15</a>
        </li>
        <li class="version">
          <a href="../../0.9.12/index.html">0.9.12</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../blog/index.html">The Mill Build Engineering Blog</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">

<div class="toolbar" role="navigation" style="position: fixed; top: 2.5rem; height: 2rem; left: 0px;">
<button class="nav-toggle"></button>
</div>
<div class="toolbar" style="position: fixed; top: 2.5rem; height: 1.5rem; right: 0px;">
<div class="edit-this-page"><a href="https://github.com/com-lihaoyi/mill/edit/main/docs/modules/ROOT/pages/extending/running-jvm-code.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Running Dynamic JVM Code</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>While <a href="import-mvn-plugins.html" class="xref page">//| mvnDeps</a> is convenient,
it comes with limitations as the JVM library it imports is global to your build:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The library has to be resolved and downloaded before any part of your build starts.
If your codebase is large and most parts of your build donât use that library,
needing to download the library when working on parts that donât need it can be wasteful</p>
</li>
<li>
<p>The library can only have one version across the entire build. This can be an issue if
you need to have multiple versions of the library used in different parts of your build.
e.g. different parts of a large Groovy codebase may use different versions of the Groovy
interpreter, and so the Groovy interpreter cannot be included via <code>//| mvnDeps</code> because the
different versions would collide.</p>
</li>
<li>
<p>The library cannot be built as part of your main build. While it is possible to build
it as part of your <a href="meta-build.html" class="xref page">Meta-Build</a>, that comes with additional
complexity and limitations. In a large codebase, you often end up building modules that
are shared between production deployments as well as local tooling: in such cases
<code>//| mvnDeps</code> is not a good fit</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In scenarios where these limitations cause issues, Mill provides other ways to run arbitrary
JVM code apart from <code>//| mvnDeps</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_subprocesses"><a class="anchor" href="#_subprocesses"></a>Subprocesses</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This example demonstrates how to resolve a third-party library from Maven Central,
but instead of using <a href="import-mvn-plugins.html" class="xref page">//| mvnDeps</a> (which loads the
library as part of the main build) we use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>defaultResolver().classpath</code> to resolve the dependencies from Maven Central,
converting <code>org:name:version</code> coordinates (and their transitive dependencies) to
<code>PathRef</code>s referring to files on disk</p>
</li>
<li>
<p><code>Jvm.runSubprocess</code>, which runs the given classpath files in a subprocess, starting
from specified <code>mainClass</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While <a href="../fundamentals/bundled-libraries.html#_os_lib" class="xref page">OS-Lib</a>'s <code>os.call</code> and <code>os.spawn</code> APIs
can be used to create any processes, JVM subprocesses are common enough have enough
idiosyncracies (e.g. classpaths) that Mill provides helper methods specifically for them.</p>
</div>
<div class="listingblock">
<div class="title">build.mill (<a href="https://repo1.maven.org/maven2/com/lihaoyi/mill-dist/1.0.4-11-564f9b/mill-dist-1.0.4-11-564f9b-example-extending-jvmcode-1-subprocess.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/1.0.4/example/extending/jvmcode/1-subprocess">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">//| mill-jvm-version: 17

package build
import mill.*, javalib.*
import mill.util.Jvm

object foo extends JavaModule {
  def groovyClasspath: Task[Seq[PathRef]] = Task {
    defaultResolver().classpath(Seq(mvn&quot;org.codehaus.groovy:groovy:3.0.9&quot;))
  }

  def groovyScript = Task.Source(&quot;generate.groovy&quot;)

  def groovyGeneratedResources = Task {
    Jvm.callProcess(
      mainClass = &quot;groovy.ui.GroovyMain&quot;,
      classPath = groovyClasspath().map(_.path).toSeq,
      mainArgs = Seq(
        groovyScript().path.toString,
        &quot;Groovy!&quot;,
        (Task.dest / &quot;groovy-generated.html&quot;).toString
      )
    )
    PathRef(Task.dest)
  }

  def resources = super.resources() ++ Seq(groovyGeneratedResources())
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this example, we use the <a href="https://groovy-lang.org/">Groovy</a> interpreter as our example
third-party library. While often used as a <code>groovy</code> CLI command, Groovy is also available
on Maven Central at the <code>org.codehaus.groovy:groovy:3.0.9</code> coordinates. This lets us pull
it into our build as a classpath comprising <code>PathRef</code>s to files on disk, and then run the
Groovy JVM main method (in the class
<a href="https://github.com/apache/groovy/blob/48c8720c04b2c15396a7b37f140e0954418f74d3/src/main/java/groovy/ui/GroovyMain.java#L113">groovy.ui.GroovyMain</a>)
passing it our script file <code>generate.groovy</code> (wired into our build using an
<a href="../fundamentals/tasks.html#_sources" class="xref page">Source Task</a> <code>groovyScript</code>) and arguments
used to configure the generated file and tell the script where to write it to. <code>generate.groovy</code>
generates a file on disk that we then wire into <code>def resources</code>, which is read at runtime
by <code>foo.run</code> and printed to the terminal output as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">&gt; ./mill foo.run
Contents of groovy-generated.html is &lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello!&lt;/h1&gt;&lt;p&gt;Groovy!&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned above, <code>defaultResolver().classpath</code> and <code>Jvm.runSubprocess</code> are an
alternative to <code>//| mvnDeps</code>, providing you more flexibility to resolve dependencies
on-demand as part of your task graph only when necessary, and keeping it isolated from
the build in a subprocess preventing classpath collisions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_in_process_isolated_classloaders"><a class="anchor" href="#_in_process_isolated_classloaders"></a>In-process Isolated Classloaders</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This example is similar to the earlier example running the Groovy interpreter in
a subprocess, but:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We use <code>Jvm.withClassLoader</code> to
load the Groovy interpreter classpath files into an in-memory in-process classloader,</p>
</li>
<li>
<p><code>loadClass</code>/<code>getMethod</code>/<code>invoke</code> to call methods on those classes using Java reflection</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">build.mill (<a href="https://repo1.maven.org/maven2/com/lihaoyi/mill-dist/1.0.4-11-564f9b/mill-dist-1.0.4-11-564f9b-example-extending-jvmcode-2-classloader.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/1.0.4/example/extending/jvmcode/2-classloader">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">//| mill-jvm-version: 17

package build
import mill.*, javalib.*
import mill.util.Jvm

object foo extends JavaModule {
  def groovyClasspath: Task[Seq[PathRef]] = Task {
    defaultResolver().classpath(Seq(mvn&quot;org.codehaus.groovy:groovy:3.0.9&quot;))
  }

  def groovyScript = Task.Source(&quot;generate.groovy&quot;)

  def groovyGeneratedResources = Task {
    Jvm.withClassLoader(classPath = groovyClasspath().map(_.path).toSeq) { classLoader =&gt;
      classLoader
        .loadClass(&quot;groovy.ui.GroovyMain&quot;)
        .getMethod(&quot;main&quot;, classOf[Array[String]])
        .invoke(
          null,
          Array[String](
            groovyScript().path.toString,
            &quot;Groovy!&quot;,
            (Task.dest / &quot;groovy-generated.html&quot;).toString
          )
        )
    }

    PathRef(Task.dest)
  }

  def resources = super.resources() ++ Seq(groovyGeneratedResources())
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that unlike <code>Jvm.runSubprocess</code>, <code>Jvm.withClassLoader</code> does not take a <code>workingDir</code>
on <code>mainArgs</code>: it instead provides you an in-memory <code>classLoader</code> that contains the
classpath you gave it. From there, you can use <code>.loadClass</code> and <code>.getMethod</code> to fish out
the classes and methods you want, and <code>.invoke</code> to call them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">&gt; ./mill foo.run
Contents of groovy-generated.html is &lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello!&lt;/h1&gt;&lt;p&gt;Groovy!&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Jvm.withClassLoader</code> has significantly less overhead than <code>Jvm.runSubprocess</code>: both in terms
of wall-clock time and in terms of memory footprint. However, it does have somewhat less
isolation, as the code is running inside your JVM and cannot be configured to have a separate
working directory, environment variables, and other process-global configs. Which one is
better to use differs on a case-by-case basis.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_classloader_worker_tasks"><a class="anchor" href="#_classloader_worker_tasks"></a>Classloader Worker Tasks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Althought running JVM bytecode via a one-off isolated classloader has less overhead
than running it in a subprocess, the fact that the classloader needs to be created
each time adds overhead: newly-created classloaders contain code that is not yet
optimized by the JVM. When performance matters, you can put the classloader in a
<code>Task.Worker</code> to keep it around, allowing the code internally to be optimized and
stay optimized without being thrown away each time</p>
</div>
<div class="paragraph">
<p>This example is similar to the earlier example running the Groovy interpreter in
a subprocess, but instead of using <code>Jvm.runSubprocess</code> we use <code>ClassLoader.create</code> to
load the Groovy interpreter classpath files:</p>
</div>
<div class="listingblock">
<div class="title">build.mill (<a href="https://repo1.maven.org/maven2/com/lihaoyi/mill-dist/1.0.4-11-564f9b/mill-dist-1.0.4-11-564f9b-example-extending-jvmcode-3-worker.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/1.0.4/example/extending/jvmcode/3-worker">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">//| mill-jvm-version: 17

package build
import mill.*, javalib.*
import mill.util.Jvm

object coursierModule extends CoursierModule

def groovyClasspath: Task[Seq[PathRef]] = Task {
  coursierModule.defaultResolver().classpath(Seq(mvn&quot;org.codehaus.groovy:groovy:3.0.9&quot;))
}

def groovyWorker: Worker[java.net.URLClassLoader] = Task.Worker {
  Jvm.createClassLoader(groovyClasspath().map(_.path).toSeq)
}

trait GroovyGenerateJavaModule extends JavaModule {
  def groovyScript = Task.Source(&quot;generate.groovy&quot;)

  def groovyGeneratedResources = Task {
    mill.api.ClassLoader.withContextClassLoader(groovyWorker()) {
      groovyWorker()
        .loadClass(&quot;groovy.ui.GroovyMain&quot;)
        .getMethod(&quot;main&quot;, classOf[Array[String]])
        .invoke(
          null,
          Array[String](
            groovyScript().path.toString,
            groovyGenerateArg(),
            (Task.dest / &quot;groovy-generated.html&quot;).toString
          )
        )
    }
    PathRef(Task.dest)
  }

  def groovyGenerateArg: T[String]
  def resources = super.resources() ++ Seq(groovyGeneratedResources())
}

object foo extends GroovyGenerateJavaModule {
  def groovyGenerateArg = &quot;Foo Groovy!&quot;
}
object bar extends GroovyGenerateJavaModule {
  def groovyGenerateArg = &quot;Bar Groovy!&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we have two modules <code>foo</code> and <code>bar</code>, each of which makes use of <code>groovyWorker</code>
to evaluate a groovy script to generate some resources. In this case, we invoke the <code>main</code>
method of <code>groovy.ui.GroovyMain</code>, which also happens to require us to set the
<code>ContextClassLoader</code> to work.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">&gt; ./mill foo.run
Contents of groovy-generated.html is &lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello!&lt;/h1&gt;&lt;p&gt;Foo Groovy!&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;

&gt; ./mill bar.run
Contents of groovy-generated.html is &lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello!&lt;/h1&gt;&lt;p&gt;Bar Groovy!&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the <code>URLClassLoader</code> within <code>groovyWorker</code> is long-lived, the code within the
classloader can be optimized by the JVM runtime, and would have less overhead than if
run in separate classloaders via <code>Jvm.runClassloader</code>. And because <code>URLClassLoader</code>
already extends <code>AutoCloseable</code>, <code>groovyWorker</code> gets treated as an
<a href="../fundamentals/tasks.html#_autoclosable_workers" class="xref page">Autocloseable Worker</a> automatically.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As mentioned in documentation for <a href="../fundamentals/tasks.html#_workers" class="xref page">Worker Tasks</a>,
the classloader contained within <code>groovyWorker</code> above is <strong>initialized</strong> in a single-thread,
but it may be <strong>used</strong> concurrently in a multi-threaded environment. Practically, that means
that the classes and methods you are invoking within the classloader do not make use of
un-synchronized global mutable variables. If the JVM logic within the classloader does
rely on mutable state, see <a href="#_caching_and_re_using_jvm_subprocesses_and_classloaders">Caching and Re-using JVM subprocesses and classloaders</a> below
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_a_javamodule_in_a_classloader"><a class="anchor" href="#_running_a_javamodule_in_a_classloader"></a>Running a JavaModule in a Classloader</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This example demonstrates how to run your own Java code within a classloader
as part of your build. We run the <code>bar</code> module code built as part of the project
within an in-memory classloader via <code>Jvm.withClassloader</code>, which in this example
serves as a code-generated to generated the <code>sources</code> of the <code>foo</code> module:</p>
</div>
<div class="listingblock">
<div class="title">build.mill (<a href="https://repo1.maven.org/maven2/com/lihaoyi/mill-dist/1.0.4-11-564f9b/mill-dist-1.0.4-11-564f9b-example-extending-jvmcode-4-module-classloader.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/1.0.4/example/extending/jvmcode/4-module-classloader">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package build
import mill.*, scalalib.*
import mill.util.Jvm

object foo extends JavaModule {
  def moduleDeps = Seq(bar)

  def sources = Task {
    Jvm.withClassLoader(classPath = bar.runClasspath().map(_.path)) { classLoader =&gt;
      classLoader
        .loadClass(&quot;bar.Bar&quot;)
        .getMethod(&quot;main&quot;, classOf[Array[String]])
        .invoke(null, Array(Task.dest.toString) ++ super.sources().map(_.path.toString))
    }
    Seq(PathRef(Task.dest))
  }
}

object bar extends JavaModule</code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned in the section on
<a href="#_in_process_isolated_classloaders">In-process Isolated Classloaders</a>,
this provides less overhead over running <code>bar</code>'s classpath in a subprocess, at
the expense of the classloader providing weaker isolation than a subprocess.
Thus we cannot rely on the working directory inside the <code>bar.Bar</code> code to be in the
right place, and instead we need to pass in the <code>Task.dest</code> path explicitly as a
<code>main</code> method parameter to the <code>bar.Bar</code> main class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">&gt; ./mill foo.run
...
Foo.value: HELLO</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_a_scalamodule_in_a_subprocess"><a class="anchor" href="#_running_a_scalamodule_in_a_subprocess"></a>Running a ScalaModule in a Subprocess</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This example demonstrates using Mill <code>ScalaModule</code>s as build tasks: rather
than pulling the code we need off of Maven Central, we instead build the code
within the <code>bar</code> module as <code>bar/src/Bar.scala</code>.</p>
</div>
<div class="listingblock">
<div class="title">build.mill (<a href="https://repo1.maven.org/maven2/com/lihaoyi/mill-dist/1.0.4-11-564f9b/mill-dist-1.0.4-11-564f9b-example-extending-jvmcode-5-module-run-task.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/1.0.4/example/extending/jvmcode/5-module-run-task">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package build
import mill.*, scalalib.*
import mill.util.Jvm

object foo extends ScalaModule {
  def scalaVersion = &quot;2.13.16&quot;
  def moduleDeps = Seq(bar)

  def sources = Task {
    bar.runner().run(args = super.sources())
    Seq(PathRef(Task.dest))
  }
}

object bar extends ScalaModule {
  def scalaVersion = &quot;2.13.16&quot;
  def mvnDeps = Seq(mvn&quot;com.lihaoyi::os-lib:0.10.7&quot;)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we use
<code>Bar.scala</code> as a source-code pre-processor on the <code>foo</code> module source code:
we override <code>foo.sources</code>, passing the <code>super.sources()</code> and <code>bar.runClasspath</code>
to <code>bar.runner().run</code> along with a <code>Task.dest</code>, and returning a <code>PathRef(Task.dest)</code>
as the new <code>foo.sources</code>. <code>bar</code> also depends on a third party library OS-Lib.
The <code>runner().run</code> subprocess runs inside the <code>Task.dest</code> folder of the enclosing
task automatically.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">&gt; ./mill foo.run
...
Foo.value: HELLO</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example does a trivial string-replace of &quot;hello&quot; with &quot;HELLO&quot;, but is
enough to demonstrate how you can use Mill <code>ScalaModule</code>s to implement your
own arbitrarily complex transformations. This is useful for build logic that
may not fit nicely inside a <code>build.mill</code> file, whether due to the sheer lines
of code or due to dependencies that may conflict with the Mill classpath
present in <code>build.mill</code></p>
</div>
<div class="paragraph">
<p><code>bar.runner().run</code> by default inherits the <code>mainClass</code>, <code>forkEnv</code>, <code>forkArgs</code>,
from the owning module <code>bar</code>, and the working directory from the calling taskâs
<code>Task.dest</code>. You can also pass in these parameters explicitly to <code>run()</code> as named
arguments if you wish to override the defaults.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">trait Runner{
  def run(args: os.Shellable,
          mainClass: String = null,
          forkArgs: Seq[String] = null,
          forkEnv: Map[String, String] = null,
          workingDir: os.Path = null,
          useCpPassingJar: java.lang.Boolean = null)
         (implicit ctx: Ctx): Unit
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_caching_and_re_using_jvm_subprocesses_and_classloaders"><a class="anchor" href="#_caching_and_re_using_jvm_subprocesses_and_classloaders"></a>Caching and Re-using JVM subprocesses and classloaders</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Java Virtual Machines are expensive to initialize and with a large memory footprint,
therefore if you tend to be doing a lot of classloader or subprocess operations it
makes sense to re-use the JVM. You can do this using the
<a href="../fundamentals/tasks.html#_cachedfactory_workers" class="xref page">CachedFactory</a> helper class, which
makes it easy to cache, re-use, and teardown these expensive long-lived components.</p>
</div>
<div class="paragraph">
<p>The example below is similar to <a href="#_running_a_javamodule_in_a_classloader">Running a JavaModule in a Classloader</a> above,
but in this case the <code>bar.Bar</code> class relies on class-level mutable state in its
implementation, and so sharing the same <code>URLClassLoader</code> across different
<code>foo*</code> tasks running on different threads is not thread-safe. To resolve this,
we make the <code>barWorker</code> contain an instance of <code>mill.api.CachedFactory</code>,
which ensures that the classloaders are created when necessary,
cached/re-used where possible, and torn down properly when no longer necessary.</p>
</div>
<div class="listingblock">
<div class="title">build.mill (<a href="https://repo1.maven.org/maven2/com/lihaoyi/mill-dist/1.0.4-11-564f9b/mill-dist-1.0.4-11-564f9b-example-extending-jvmcode-6-module-cached-classloader.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/1.0.4/example/extending/jvmcode/6-module-cached-classloader">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package build
import mill.*, scalalib.*
import mill.util.Jvm
import mill.util.CachedFactory
import java.net.{URL, URLClassLoader}

trait FooModule extends JavaModule {
  def moduleDeps = Seq(bar)

  def sources = Task {
    barWorker().withValue(()) { classLoader =&gt;
      classLoader
        .loadClass(&quot;bar.Bar&quot;)
        .getMethod(&quot;main&quot;, classOf[Array[String]])
        .invoke(null, Array(Task.dest.toString) ++ super.sources().map(_.path.toString))
    }
    Seq(PathRef(Task.dest))
  }
}

object foo1 extends FooModule
object foo2 extends FooModule
object foo3 extends FooModule

def barWorker: Worker[BarWorker] = Task.Worker {
  new BarWorker(bar.runClasspath().map(_.path).toSeq)
}

class BarWorker(runClasspath: Seq[os.Path]) extends CachedFactory[Unit, URLClassLoader] {
  def setup(key: Unit) = {
    println(&quot;Setting up Classloader&quot;)
    Jvm.createClassLoader(runClasspath)
  }
  def teardown(key: Unit, value: URLClassLoader) = {
    println(&quot;Tearing down Classloader&quot;)
    value.close()
  }
  def maxCacheSize = 2
}

object bar extends JavaModule</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">&gt; ./mill '{foo1,foo2,foo3}.run' # 3 classloaders are setup, one is torn down due to maxCacheSize
Setting up Classloader
Setting up Classloader
Setting up Classloader
Tearing down Classloader
Foo.value: HELLO

&gt; ./mill clean # mill clean tears down the 2 remaining classloaders
Tearing down Classloader
Tearing down Classloader</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="thirdparty-plugins.html">Third-Party Plugins</a></span>
  <span class="next"><a href="writing-plugins.html">Writing Mill Plugins</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async="async" src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async="async" src="../../../search-index.js"></script>
  
</body></html>