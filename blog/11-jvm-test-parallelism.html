<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Strategies for Efficiently Parallelizing JVM Test Suites :: The Mill Build Tool</title>
    <link rel="canonical" href="https://mill-build.org/blog/11-jvm-test-parallelism.html" />
    <link rel="prev" href="12-direct-style-build-tool.html" />
    <link rel="next" href="10-bytecode-callgraph-analysis.html" />
    <meta name="generator" content="Antora 3.1.12" />
    <link rel="stylesheet" href="../_/css/site.css" />
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-1C582ZJR85"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-1C582ZJR85')</script>
<link rel="icon" href="../_/favicon.png" type="image/x-icon" />
  
  <style>
  /* auto-hyphenation is super ugly */
  *{
    hyphens: manual !important;
  }

  /* Reduce font size from 17px to something reasonable */
  .doc {
   font-size: 16px !important;
  }
  .doc pre {
   font-size: 14px !important;
  }
  /* Shrink unreasonably large top bar */
  nav.navbar{
    height: 2.5rem;
  }
  body.article{
    padding-top: 2.5rem;
  }
  div.nav-container{
    top: 2.5rem;
  }
  div.toolbar{
    top: 2.5rem;
  }
  aside.nav{
    top: 2.5rem;
    height: calc(100vh - 2.5rem);
  }
  </style></head><body class="article">
  
<header class="header">
  
  <script>
  gtag('config', 'AW-16649289906');

  document.addEventListener('DOMContentLoaded', function() {
  const links = document.querySelectorAll('a');
    links.forEach(link => {
      if (link.textContent.trim().toLowerCase() === 'download') {
        link.addEventListener('click', function(event) {
          console.log("download link clicked")
          gtag('event', 'conversion', {'send_to': 'AW-16649289906/rsphCKfVq8QZELKBgIM-'});
        });
      }
    });
  });
  </script>
  <nav class="navbar">
    <div class="navbar-brand">
      <!-- TODO: add mill icon -->
      <a class="navbar-item" href="https://mill-build.org"><img src="../_/logo-white.svg" height="20" /> The Mill Build Tool</a>
      <div class="navbar-item search">
        <input id="search-input" type="text" placeholder="Search the docs" />
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill">GitHub</a>
        <a class="navbar-item" href="https://mill-build.org/blog/index.html">Blog</a>
        <a class="navbar-item" href="https://mill-build.org/api/latest/mill.html">API</a>
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill/issues">Issues</a>
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill/discussions">Discuss</a>


            <!--
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Documentation</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#"></a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Plugins</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
        -->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="blog" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list">

  <li class="nav-item" data-depth="0">
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html"><em>The Mill Build Engineering Blog</em></a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="16-zero-setup.html">Zero-Setup Java Build Tooling via Mill Bootstrap Scripts</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="15-android-build-flow.html">Mill as an Alternative Android Build Tool</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="14-bash-zsh-completion.html">Writing Your Own Simple Tab-Completions for Bash and Zsh</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="13-mill-build-tool-v1-0-0.html">Mill Build Tool v1.0.0 Release Highlights</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="12-direct-style-build-tool.html">Mill as a Direct Style Build Tool</a>
  </li>

  <li class="nav-item is-current-page is-active" data-depth="1">
    <a class="nav-link" href="11-jvm-test-parallelism.html">Strategies for Efficiently Parallelizing JVM Test Suites</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="10-bytecode-callgraph-analysis.html">Invalidating build caches using JVM bytecode callgraph analysis</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="9-mill-faster-assembly-jars.html">Fast Incremental JVM Assembly Jar Creation with Mill</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="8-what-is-a-build-tool.html">What does a Build Tool do?</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="7-graal-native-executables.html">How to Compile Java into Native Binaries with Mill and Graal</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="6-garbage-collector-perf.html">Understanding JVM Garbage Collector Performance</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="5-executable-jars.html">How JVM Executable Assembly Jars Work</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="4-flaky-tests.html">How To Manage Flaky Tests in your CI Workflows</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="3-selective-testing.html">Faster CI with Selective Testing</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="2-monorepo-build-tool.html">Why Use a Monorepo Build Tool?</a>
  </li>

  <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="1-java-compile.html">How Fast Does Java Compile?</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">The Mill Build Engineering Blog</span>
    <span class="version"></span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../mill/index.html">Mill Documentation</a></div>
      <ul class="versions">
        <li class="version">
          <a href="../mill/main-branch/index.html">main-branch</a>
        </li>
        <li class="version is-latest">
          <a href="../mill/index.html">1.1.0-RC3</a>
        </li>
        <li class="version">
          <a href="../mill/1.0.x/index.html">1.0.6</a>
        </li>
        <li class="version">
          <a href="../mill/0.12.x/index.html">0.12.16</a>
        </li>
        <li class="version">
          <a href="../mill/0.11.x/index.html">0.11.13</a>
        </li>
        <li class="version">
          <a href="../mill/0.10.15/index.html">0.10.15</a>
        </li>
        <li class="version">
          <a href="../mill/0.9.12/index.html">0.9.12</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <div class="title"><a href="index.html">The Mill Build Engineering Blog</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">

<div class="toolbar" role="navigation" style="position: fixed; top: 2.5rem; height: 2rem; left: 0px;">
<button class="nav-toggle"></button>
</div>
<div class="toolbar" style="position: fixed; top: 2.5rem; height: 1.5rem; right: 0px;">
<div class="edit-this-page"><a href="https://github.com/com-lihaoyi/mill/edit/main/out/website/blogFolder.dest/modules/ROOT/pages/11-jvm-test-parallelism.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Strategies for Efficiently Parallelizing JVM Test Suites</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Li Haoyi, 17 March 2025</em></p>
</div>
<div class="paragraph">
<p>Test suites are in theory the ideal workload to parallelize, as they usually contain a large
number of independent tests that can each be run in parallel. But implementing parallelism in
practice can be challenging: a naive implementation can easily result in increased resource usage
without any speedup, or even slow things down compared to running things on a single thread.</p>
</div>
<div class="paragraph">
<p>This blog post will explore the design and evolution of the Mill JVM build tool’s test
parallelism strategy, from its start as a simple serial test runner, to naive module-based and
class-based sharding, to the dynamic sharding strategy implemented in the latest
version of Mill 0.12.9. We will discuss the pros and cons of the different approaches to
test parallelization, analyze how they perform both theoretically and with benchmarks,
and compare them to the runtime characteristics of other build tool test runners.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serial_execution"><a class="anchor" href="#_serial_execution"></a>Serial Execution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Mill build tool started off without any parallelism by default, and that extended to
tests as well. When asked to execute tasks, Mill would:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Receive the build tasks specified at the command line</p>
</li>
<li>
<p>Do a <a href="https://en.wikipedia.org/wiki/Breadth-first_search">breadth first search</a> on the task graph to find the full list of transitive tasks</p>
</li>
<li>
<p>Sort the tasks in topological order using <a href="https://en.wikipedia.org/wiki/Tarjan%27s_strongly_connected_components_algorithm">Tarjan’s Algorithm</a></p>
</li>
<li>
<p>Execute the tasks in order one at a time, skipping those with earlier cached values it can re-use</p>
</li>
<li>
<p>If any tasks contained test suites, these would be run one at a time in a single JVM subprocess</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>While this serial execution works fine, it’s unsatisfying in a world of modern
computers each of which has anywhere from 8-16 CPU cores you can make use of. You may be
waiting seconds or minutes for your tests to run on 1 CPU core while the other 9 cores are sitting idle.</p>
</div>
<div class="paragraph">
<p>To evaluate how well <em>Serial Execution</em> and later parallelism strategies,
we performed two analyses:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A theoretical analysis using a simplified example build, the kind you would do on a whiteboard</p>
</li>
<li>
<p>A practical benchmark using two real-world codebases with very different testing workloads</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These benchmarks are rough, but are enough to give
a good understanding of the benefits and tradeoffs involved with
the different parallelization strategies we discuss.</p>
</div>
<div class="sect2">
<h3 id="_theoretical_evaluation"><a class="anchor" href="#_theoretical_evaluation"></a>Theoretical Evaluation</h3>
<div class="paragraph">
<p>To understand the concepts behind each strategy, we imagine using it to run the tests
on a simple example build with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>3 <code>test</code> modules, <code>ModuleA</code>, <code>ModuleB</code>, and <code>ModuleC</code></p>
</li>
<li>
<p>These three <code>test</code> modules have 2,4, and 6 test classes respectively</p>
</li>
<li>
<p>Running in an environment with 3 CPUs available</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can see this visualized below for <em>serial execution</em>:</p>
</div>
<div class="paragraph">
<center>
<svg width="742px" height="235px" viewBox="0.00 0.00 742.16 235.00" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 231.0)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-231 738.16,-231 738.16,4 -4,4"></polygon>
<g id="clust2" class="cluster">
<title>cluster_b</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8.38,-81 8.38,-146 480.62,-146 480.62,-81 8.38,-81"></polygon>
<text text-anchor="middle" x="244.5" y="-129.4" font-family="Times,serif" font-size="14.00">ModuleB.test</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_c</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8.38,-8 8.38,-73 726.16,-73 726.16,-8 8.38,-8"></polygon>
<text text-anchor="middle" x="367.27" y="-56.4" font-family="Times,serif" font-size="14.00">ModuleC.test</text>
</g>
<g id="clust1" class="cluster">
<title>cluster_a</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8,-154 8,-219 235.08,-219 235.08,-154 8,-154"></polygon>
<text text-anchor="middle" x="121.54" y="-202.4" font-family="Times,serif" font-size="14.00">ModuleA.test</text>
</g>
<!-- TestClassA1 -->
<g id="node1" class="node">
<title>TestClassA1</title>
<polygon fill="lightpink" stroke="black" points="103.31,-186.3 16.23,-186.3 16.23,-161.7 103.31,-161.7 103.31,-186.3"></polygon>
<text text-anchor="middle" x="59.77" y="-169.8" font-family="Times,serif" font-size="14.00">TestClassA1</text>
</g>
<!-- TestClassA2 -->
<g id="node2" class="node">
<title>TestClassA2</title>
<polygon fill="lightpink" stroke="black" points="226.85,-186.3 139.77,-186.3 139.77,-161.7 226.85,-161.7 226.85,-186.3"></polygon>
<text text-anchor="middle" x="183.31" y="-169.8" font-family="Times,serif" font-size="14.00">TestClassA2</text>
</g>
<!-- TestClassA1&#45;&gt;TestClassA2 -->
<g id="edge1" class="edge">
<title>TestClassA1-&gt;TestClassA2</title>
<path fill="none" stroke="black" d="M103.62,-174C111.88,-174 120.63,-174 129.17,-174"></path>
<polygon fill="black" stroke="black" points="129.44,-177.5 139.44,-174 129.44,-170.5 129.44,-177.5"></polygon>
</g>
<!-- TestClassB1 -->
<g id="node3" class="node">
<title>TestClassB1</title>
<polygon fill="lightgreen" stroke="black" points="103.04,-113.3 16.5,-113.3 16.5,-88.7 103.04,-88.7 103.04,-113.3"></polygon>
<text text-anchor="middle" x="59.77" y="-96.8" font-family="Times,serif" font-size="14.00">TestClassB1</text>
</g>
<!-- TestClassA2&#45;&gt;TestClassB1 -->
<g id="edge10" class="edge">
<title>TestClassA2-&gt;TestClassB1</title>
<path fill="none" stroke="black" d="M161.59,-161.56C141.91,-149.74 112.13,-131.85 90.04,-118.58"></path>
<polygon fill="black" stroke="black" points="91.76,-115.53 81.39,-113.38 88.16,-121.53 91.76,-115.53"></polygon>
</g>
<!-- TestClassB2 -->
<g id="node4" class="node">
<title>TestClassB2</title>
<polygon fill="lightgreen" stroke="black" points="226.58,-113.3 140.04,-113.3 140.04,-88.7 226.58,-88.7 226.58,-113.3"></polygon>
<text text-anchor="middle" x="183.31" y="-96.8" font-family="Times,serif" font-size="14.00">TestClassB2</text>
</g>
<!-- TestClassB1&#45;&gt;TestClassB2 -->
<g id="edge2" class="edge">
<title>TestClassB1-&gt;TestClassB2</title>
<path fill="none" stroke="black" d="M103.28,-101C111.84,-101 120.93,-101 129.79,-101"></path>
<polygon fill="black" stroke="black" points="130.03,-104.5 140.03,-101 130.03,-97.5 130.03,-104.5"></polygon>
</g>
<!-- TestClassB3 -->
<g id="node5" class="node">
<title>TestClassB3</title>
<polygon fill="lightgreen" stroke="black" points="349.74,-113.3 263.19,-113.3 263.19,-88.7 349.74,-88.7 349.74,-113.3"></polygon>
<text text-anchor="middle" x="306.46" y="-96.8" font-family="Times,serif" font-size="14.00">TestClassB3</text>
</g>
<!-- TestClassB2&#45;&gt;TestClassB3 -->
<g id="edge3" class="edge">
<title>TestClassB2-&gt;TestClassB3</title>
<path fill="none" stroke="black" d="M226.68,-101C235.12,-101 244.08,-101 252.81,-101"></path>
<polygon fill="black" stroke="black" points="252.91,-104.5 262.91,-101 252.91,-97.5 252.91,-104.5"></polygon>
</g>
<!-- TestClassB4 -->
<g id="node6" class="node">
<title>TestClassB4</title>
<polygon fill="lightgreen" stroke="black" points="472.51,-113.3 385.96,-113.3 385.96,-88.7 472.51,-88.7 472.51,-113.3"></polygon>
<text text-anchor="middle" x="429.23" y="-96.8" font-family="Times,serif" font-size="14.00">TestClassB4</text>
</g>
<!-- TestClassB3&#45;&gt;TestClassB4 -->
<g id="edge4" class="edge">
<title>TestClassB3-&gt;TestClassB4</title>
<path fill="none" stroke="black" d="M350.04,-101C358.25,-101 366.94,-101 375.43,-101"></path>
<polygon fill="black" stroke="black" points="375.63,-104.5 385.63,-101 375.63,-97.5 375.63,-104.5"></polygon>
</g>
<!-- TestClassC1 -->
<g id="node7" class="node">
<title>TestClassC1</title>
<polygon fill="lightblue" stroke="black" points="103.04,-40.3 16.5,-40.3 16.5,-15.7 103.04,-15.7 103.04,-40.3"></polygon>
<text text-anchor="middle" x="59.77" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC1</text>
</g>
<!-- TestClassB4&#45;&gt;TestClassC1 -->
<g id="edge11" class="edge">
<title>TestClassB4-&gt;TestClassC1</title>
<path fill="none" stroke="black" d="M385.93,-92.44C318.08,-79.04 186.87,-53.11 113.23,-38.56"></path>
<polygon fill="black" stroke="black" points="113.73,-35.09 103.24,-36.59 112.37,-41.96 113.73,-35.09"></polygon>
</g>
<!-- TestClassC2 -->
<g id="node8" class="node">
<title>TestClassC2</title>
<polygon fill="lightblue" stroke="black" points="226.58,-40.3 140.04,-40.3 140.04,-15.7 226.58,-15.7 226.58,-40.3"></polygon>
<text text-anchor="middle" x="183.31" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC2</text>
</g>
<!-- TestClassC1&#45;&gt;TestClassC2 -->
<g id="edge5" class="edge">
<title>TestClassC1-&gt;TestClassC2</title>
<path fill="none" stroke="black" d="M103.28,-28C111.84,-28 120.93,-28 129.79,-28"></path>
<polygon fill="black" stroke="black" points="130.03,-31.5 140.03,-28 130.03,-24.5 130.03,-31.5"></polygon>
</g>
<!-- TestClassC3 -->
<g id="node9" class="node">
<title>TestClassC3</title>
<polygon fill="lightblue" stroke="black" points="349.74,-40.3 263.19,-40.3 263.19,-15.7 349.74,-15.7 349.74,-40.3"></polygon>
<text text-anchor="middle" x="306.46" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC3</text>
</g>
<!-- TestClassC2&#45;&gt;TestClassC3 -->
<g id="edge6" class="edge">
<title>TestClassC2-&gt;TestClassC3</title>
<path fill="none" stroke="black" d="M226.68,-28C235.12,-28 244.08,-28 252.81,-28"></path>
<polygon fill="black" stroke="black" points="252.91,-31.5 262.91,-28 252.91,-24.5 252.91,-31.5"></polygon>
</g>
<!-- TestClassC4 -->
<g id="node10" class="node">
<title>TestClassC4</title>
<polygon fill="lightblue" stroke="black" points="472.51,-40.3 385.96,-40.3 385.96,-15.7 472.51,-15.7 472.51,-40.3"></polygon>
<text text-anchor="middle" x="429.23" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC4</text>
</g>
<!-- TestClassC3&#45;&gt;TestClassC4 -->
<g id="edge7" class="edge">
<title>TestClassC3-&gt;TestClassC4</title>
<path fill="none" stroke="black" d="M350.04,-28C358.25,-28 366.94,-28 375.43,-28"></path>
<polygon fill="black" stroke="black" points="375.63,-31.5 385.63,-28 375.63,-24.5 375.63,-31.5"></polygon>
</g>
<!-- TestClassC5 -->
<g id="node11" class="node">
<title>TestClassC5</title>
<polygon fill="lightblue" stroke="black" points="595.28,-40.3 508.73,-40.3 508.73,-15.7 595.28,-15.7 595.28,-40.3"></polygon>
<text text-anchor="middle" x="552" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC5</text>
</g>
<!-- TestClassC4&#45;&gt;TestClassC5 -->
<g id="edge8" class="edge">
<title>TestClassC4-&gt;TestClassC5</title>
<path fill="none" stroke="black" d="M472.81,-28C481.02,-28 489.71,-28 498.2,-28"></path>
<polygon fill="black" stroke="black" points="498.4,-31.5 508.4,-28 498.4,-24.5 498.4,-31.5"></polygon>
</g>
<!-- TestClassC6 -->
<g id="node12" class="node">
<title>TestClassC6</title>
<polygon fill="lightblue" stroke="black" points="718.05,-40.3 631.5,-40.3 631.5,-15.7 718.05,-15.7 718.05,-40.3"></polygon>
<text text-anchor="middle" x="674.77" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC6</text>
</g>
<!-- TestClassC5&#45;&gt;TestClassC6 -->
<g id="edge9" class="edge">
<title>TestClassC5-&gt;TestClassC6</title>
<path fill="none" stroke="black" d="M595.58,-28C603.79,-28 612.48,-28 620.97,-28"></path>
<polygon fill="black" stroke="black" points="621.17,-31.5 631.17,-28 621.17,-24.5 621.17,-31.5"></polygon>
</g>
</g>
</svg>

</center>
</div>
<div class="ulist">
<ul>
<li>
<p>The colored boxes represent <em>test classes</em>. This is a common unit of managing tests in
the JVM ecosystem, and will serve as the base level of granularity for this article.</p>
</li>
<li>
<p>The arrows represent the threads on which the test classes execute on, and in the case
of <em>serial execution</em> they all execute on a single thread.</p>
</li>
<li>
<p>The dashed boxes represent the testrunner processes that were spawned. In this case,
every module’s tests are run in a separate process, which is again a common approach
to isolate the code of different modules from one another.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For this article, we assume that tests for different modules need to be run in
different subprocesses. That is not universally true: Mill does have a <code>testLocal</code>
mode that runs tests in a shared JVM to reduce overhead, at the expense of some flexibility
and isolation, and other build tools have something similar. But we find that
process-separation of different modules' test suites is a useful enough default that
we will assume it necessary for the rest of this article.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Given this example test run, there are two numbers we would like to minimize:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Time taken</strong> for all tests to complete. For this analyis, we treat each <code>TestClass</code>
as taking the same amount of time, and just add up the number of suites on the longest
thread</p>
</li>
<li>
<p><strong>Processes</strong> spawned. Spawning processes are expensive, especially
JVM processes that may take several seconds to launch and warm up to peak performance.
Again, we just assume that every process spawn has the same overhead, and add it up</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <em>Serial Execution</em>, the numbers are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;" />
<col style="width: 50%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Serial Execution</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time Taken</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>12</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>3</strong></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_practical_evaluation"><a class="anchor" href="#_practical_evaluation"></a>Practical Evaluation</h3>
<div class="paragraph">
<p>For the practical evaluation, we considered the test suites of two different codebases:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The subset of unit tests in the <a href="https://github.com/netty/netty">Netty codebase</a>
that run in the <a href="../mill/comparisons/maven.html" class="xref page">Mill example Netty build</a>.
These contain a large number modules (17) with a large number of test classes (233),
but each test class runs relatively quickly (~0.1s). This kind of testing workload is often
seen in library codebases where all logic and tests can take place quickly in memory.</p>
</li>
<li>
<p>The tests of Mill’s own <code>scalalib</code> module. This is a single large module with a
large number of test classes (52), but each test class runs relatively slowly (~10s). While
not ideal, this kind of testing workload is common in monolithic application codebases with
heavy integration testing.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In summary:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test Classes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Average Duration per Test Class</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Netty unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">233</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~0.1s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mill scalalib tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">52</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~10s</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The commands to run these two benchmarks are shown below, with <code>-j1</code> telling Mill to
run things on a single thread:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">netty$ ./mill show 'codec-{dns,haproxy,http,http2,memcache,mqtt,redis,smtp,socks,stomp,xml}.__.discoveredTestClasses' + 'transport-{blockhound-tests,native-unix-common,sctp}.__.discoveredTestClasses'
mill$ ./mill -j1 scalalib.test</code></pre>
</div>
</div>
<div class="paragraph">
<p>The selection of test suites in the Netty codebase is somewhat arbitrary (the tests that
the example build happens to contain), but that doesn’t matter since we will be running the same
selection of tests throughout this article to see the effect of these tests.</p>
</div>
<div class="paragraph">
<p>These two workloads are very different, and benefit from different characteristics in the
parallel test runner:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For fast unit tests, minimizing the number of processes spawned is important, since the 0.1s
it take to run the tests themselves can easily be dominated by 1s overhead starting up a JVM
test process</p>
</li>
<li>
<p>For slower integration tests, the minimizing the number of processes matters less, as adding
1s of process spawning overhead to a 10s test class is inconvenient but not overwhelming</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will see how these numbers vary as we explore different testing strategies
below, but as a baseline the time taken for running these test suites under <em>Serial Execution</em>
is as follows</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;" />
<col style="width: 50%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Serial Execution</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Netty unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>28s</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mill scalalib tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>502s</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These results are from running the above commands ad-hoc on my M1 Macbook Pro with 10 cores
and Java 17.
The exact numbers will vary based on what test suite you choose and what hardware you run
it, but the overall trends and conclusions should be the same.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_module_sharding"><a class="anchor" href="#_module_sharding"></a>Module Sharding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mill has always had task-level parallelism opt-in via the <code>-j</code>/<code>--jobs</code>
flag (the name taken from the <a href="https://en.wikipedia.org/wiki/Make_%28software%29">Make tool</a>),
and it became the default in Mill <code>0.12.0</code> for tasks to run parallel to use
all cores on your system. During testing, typically each Mill module <code>foo</code> would
have a single <code>foo.test</code> sub-module, with a single <code>foo.test.testForked</code> task.
This means that Mill’s <em>task-level parallelism</em> would effectively shards your test suites
at a <em>module level</em>.</p>
</div>
<div class="paragraph">
<p>One consequence of this is that if your codebase was broken up into many small modules,
each module’s tests could run in parallel. But if your codebase had a few large modules,
you may not be able to make full use of all the CPU cores available on your machine.</p>
</div>
<div class="paragraph">
<p>Visualizing this on the theoretical example we saw earlier:</p>
</div>
<div class="paragraph">
<center>
<svg width="742px" height="235px" viewBox="0.00 0.00 742.16 235.00" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 231.0)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-231 738.16,-231 738.16,4 -4,4"></polygon>
<g id="clust3" class="cluster">
<title>cluster_a</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8,-154 8,-219 235.08,-219 235.08,-154 8,-154"></polygon>
<text text-anchor="middle" x="121.54" y="-202.4" font-family="Times,serif" font-size="14.00">ModuleA.test</text>
</g>
<g id="clust1" class="cluster">
<title>cluster_c</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8.38,-8 8.38,-73 726.16,-73 726.16,-8 8.38,-8"></polygon>
<text text-anchor="middle" x="367.27" y="-56.4" font-family="Times,serif" font-size="14.00">ModuleC.test</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_b</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8.38,-81 8.38,-146 480.62,-146 480.62,-81 8.38,-81"></polygon>
<text text-anchor="middle" x="244.5" y="-129.4" font-family="Times,serif" font-size="14.00">ModuleB.test</text>
</g>
<!-- TestClassC1 -->
<g id="node1" class="node">
<title>TestClassC1</title>
<polygon fill="lightblue" stroke="black" points="103.04,-40.3 16.5,-40.3 16.5,-15.7 103.04,-15.7 103.04,-40.3"></polygon>
<text text-anchor="middle" x="59.77" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC1</text>
</g>
<!-- TestClassC2 -->
<g id="node2" class="node">
<title>TestClassC2</title>
<polygon fill="lightblue" stroke="black" points="226.58,-40.3 140.04,-40.3 140.04,-15.7 226.58,-15.7 226.58,-40.3"></polygon>
<text text-anchor="middle" x="183.31" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC2</text>
</g>
<!-- TestClassC1&#45;&gt;TestClassC2 -->
<g id="edge1" class="edge">
<title>TestClassC1-&gt;TestClassC2</title>
<path fill="none" stroke="black" d="M103.28,-28C111.84,-28 120.93,-28 129.79,-28"></path>
<polygon fill="black" stroke="black" points="130.03,-31.5 140.03,-28 130.03,-24.5 130.03,-31.5"></polygon>
</g>
<!-- TestClassC3 -->
<g id="node3" class="node">
<title>TestClassC3</title>
<polygon fill="lightblue" stroke="black" points="349.74,-40.3 263.19,-40.3 263.19,-15.7 349.74,-15.7 349.74,-40.3"></polygon>
<text text-anchor="middle" x="306.46" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC3</text>
</g>
<!-- TestClassC2&#45;&gt;TestClassC3 -->
<g id="edge2" class="edge">
<title>TestClassC2-&gt;TestClassC3</title>
<path fill="none" stroke="black" d="M226.68,-28C235.12,-28 244.08,-28 252.81,-28"></path>
<polygon fill="black" stroke="black" points="252.91,-31.5 262.91,-28 252.91,-24.5 252.91,-31.5"></polygon>
</g>
<!-- TestClassC4 -->
<g id="node4" class="node">
<title>TestClassC4</title>
<polygon fill="lightblue" stroke="black" points="472.51,-40.3 385.96,-40.3 385.96,-15.7 472.51,-15.7 472.51,-40.3"></polygon>
<text text-anchor="middle" x="429.23" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC4</text>
</g>
<!-- TestClassC3&#45;&gt;TestClassC4 -->
<g id="edge3" class="edge">
<title>TestClassC3-&gt;TestClassC4</title>
<path fill="none" stroke="black" d="M350.04,-28C358.25,-28 366.94,-28 375.43,-28"></path>
<polygon fill="black" stroke="black" points="375.63,-31.5 385.63,-28 375.63,-24.5 375.63,-31.5"></polygon>
</g>
<!-- TestClassC5 -->
<g id="node5" class="node">
<title>TestClassC5</title>
<polygon fill="lightblue" stroke="black" points="595.28,-40.3 508.73,-40.3 508.73,-15.7 595.28,-15.7 595.28,-40.3"></polygon>
<text text-anchor="middle" x="552" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC5</text>
</g>
<!-- TestClassC4&#45;&gt;TestClassC5 -->
<g id="edge4" class="edge">
<title>TestClassC4-&gt;TestClassC5</title>
<path fill="none" stroke="black" d="M472.81,-28C481.02,-28 489.71,-28 498.2,-28"></path>
<polygon fill="black" stroke="black" points="498.4,-31.5 508.4,-28 498.4,-24.5 498.4,-31.5"></polygon>
</g>
<!-- TestClassC6 -->
<g id="node6" class="node">
<title>TestClassC6</title>
<polygon fill="lightblue" stroke="black" points="718.05,-40.3 631.5,-40.3 631.5,-15.7 718.05,-15.7 718.05,-40.3"></polygon>
<text text-anchor="middle" x="674.77" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC6</text>
</g>
<!-- TestClassC5&#45;&gt;TestClassC6 -->
<g id="edge5" class="edge">
<title>TestClassC5-&gt;TestClassC6</title>
<path fill="none" stroke="black" d="M595.58,-28C603.79,-28 612.48,-28 620.97,-28"></path>
<polygon fill="black" stroke="black" points="621.17,-31.5 631.17,-28 621.17,-24.5 621.17,-31.5"></polygon>
</g>
<!-- TestClassB1 -->
<g id="node7" class="node">
<title>TestClassB1</title>
<polygon fill="lightgreen" stroke="black" points="103.04,-113.3 16.5,-113.3 16.5,-88.7 103.04,-88.7 103.04,-113.3"></polygon>
<text text-anchor="middle" x="59.77" y="-96.8" font-family="Times,serif" font-size="14.00">TestClassB1</text>
</g>
<!-- TestClassB2 -->
<g id="node8" class="node">
<title>TestClassB2</title>
<polygon fill="lightgreen" stroke="black" points="226.58,-113.3 140.04,-113.3 140.04,-88.7 226.58,-88.7 226.58,-113.3"></polygon>
<text text-anchor="middle" x="183.31" y="-96.8" font-family="Times,serif" font-size="14.00">TestClassB2</text>
</g>
<!-- TestClassB1&#45;&gt;TestClassB2 -->
<g id="edge6" class="edge">
<title>TestClassB1-&gt;TestClassB2</title>
<path fill="none" stroke="black" d="M103.28,-101C111.84,-101 120.93,-101 129.79,-101"></path>
<polygon fill="black" stroke="black" points="130.03,-104.5 140.03,-101 130.03,-97.5 130.03,-104.5"></polygon>
</g>
<!-- TestClassB3 -->
<g id="node9" class="node">
<title>TestClassB3</title>
<polygon fill="lightgreen" stroke="black" points="349.74,-113.3 263.19,-113.3 263.19,-88.7 349.74,-88.7 349.74,-113.3"></polygon>
<text text-anchor="middle" x="306.46" y="-96.8" font-family="Times,serif" font-size="14.00">TestClassB3</text>
</g>
<!-- TestClassB2&#45;&gt;TestClassB3 -->
<g id="edge7" class="edge">
<title>TestClassB2-&gt;TestClassB3</title>
<path fill="none" stroke="black" d="M226.68,-101C235.12,-101 244.08,-101 252.81,-101"></path>
<polygon fill="black" stroke="black" points="252.91,-104.5 262.91,-101 252.91,-97.5 252.91,-104.5"></polygon>
</g>
<!-- TestClassB4 -->
<g id="node10" class="node">
<title>TestClassB4</title>
<polygon fill="lightgreen" stroke="black" points="472.51,-113.3 385.96,-113.3 385.96,-88.7 472.51,-88.7 472.51,-113.3"></polygon>
<text text-anchor="middle" x="429.23" y="-96.8" font-family="Times,serif" font-size="14.00">TestClassB4</text>
</g>
<!-- TestClassB3&#45;&gt;TestClassB4 -->
<g id="edge8" class="edge">
<title>TestClassB3-&gt;TestClassB4</title>
<path fill="none" stroke="black" d="M350.04,-101C358.25,-101 366.94,-101 375.43,-101"></path>
<polygon fill="black" stroke="black" points="375.63,-104.5 385.63,-101 375.63,-97.5 375.63,-104.5"></polygon>
</g>
<!-- TestClassA1 -->
<g id="node11" class="node">
<title>TestClassA1</title>
<polygon fill="lightpink" stroke="black" points="103.31,-186.3 16.23,-186.3 16.23,-161.7 103.31,-161.7 103.31,-186.3"></polygon>
<text text-anchor="middle" x="59.77" y="-169.8" font-family="Times,serif" font-size="14.00">TestClassA1</text>
</g>
<!-- TestClassA2 -->
<g id="node12" class="node">
<title>TestClassA2</title>
<polygon fill="lightpink" stroke="black" points="226.85,-186.3 139.77,-186.3 139.77,-161.7 226.85,-161.7 226.85,-186.3"></polygon>
<text text-anchor="middle" x="183.31" y="-169.8" font-family="Times,serif" font-size="14.00">TestClassA2</text>
</g>
<!-- TestClassA1&#45;&gt;TestClassA2 -->
<g id="edge9" class="edge">
<title>TestClassA1-&gt;TestClassA2</title>
<path fill="none" stroke="black" d="M103.62,-174C111.88,-174 120.63,-174 129.17,-174"></path>
<polygon fill="black" stroke="black" points="129.44,-177.5 139.44,-174 129.44,-170.5 129.44,-177.5"></polygon>
</g>
</g>
</svg>

</center>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;" />
<col style="width: 33.3333%;" />
<col style="width: 33.3334%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial Execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Module Sharding</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time Taken</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>6</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>3</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We can see that because the three modules have different numbers of test classes
within them, <code>ModuleA.test</code> finishes first and that thread/CPU is idle until <code>ModuleB.test</code> and
<code>ModuleC.test</code> finish later. While not ideal, this is a significant improvement over
<em>Serial Execution</em> in our theoretical example, shortening the time taken from 12
to 6, while preserving the number of processes spawned at 3.</p>
</div>
<div class="paragraph">
<p>The practical benchmarks also show significant improvements for the Netty unit tests,
running 3x faster as they can take full advantage of the multiple cores on the machine
parallelize the test suites of the 17 modules being tested.
However the Mill scalalib tests show no significant speedup, as the benchmark is a single
large module that does not benefit from module sharding.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;" />
<col style="width: 33.3333%;" />
<col style="width: 33.3334%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Serial Execution</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Module Sharding</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Netty unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>10s</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mill scalalib tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">502s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>477s</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>While in theory it would be ideal to break up large monoliths into multiple smaller modules
each with their own test suite, doing so is tedious and manual, and realistically does
not happen as often or as quickly as one might prefer. Thus a build tool needs
to be able to handle these large monolithic modules and their large monolithic test suites
in some reasonable manner.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_static_class_sharding"><a class="anchor" href="#_static_class_sharding"></a>Static Class Sharding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To work around the limitations of <em>module sharding</em>, Mill <code>0.12.0</code> introduced <em>static class sharding</em>,
opt-in via the <code>def testForkGrouping</code> flag. This allows the developer to take the <code>Seq[String]</code> containing
all the test class names and return a nested <code>Seq[Seq[String]]</code> with the original list broken down
into groups. Each test group would run in parallel in a separate process in a separate folder,
but within each group the tests would still run sequentially.</p>
</div>
<div class="paragraph">
<p>For example, the following configuration would take the list of test classes
and break it down into 1-element groups:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def testForkGrouping = discoveredTestClasses().grouped(1).toSeq</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using static test sharding, the execution of the test suites in our theoretical example now
has each test class assigned its own process (dashed boxes), and those processes
making full use of the three cores available in the example:</p>
</div>
<div class="paragraph">
<center>
<svg width="496px" height="160px" viewBox="0.00 0.00 495.85 160.00" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 156.0)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-156 491.85,-156 491.85,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_c1</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="254.31,-104 254.31,-144 357.08,-144 357.08,-104 254.31,-104"></polygon>
</g>
<g id="clust2" class="cluster">
<title>cluster_c2</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="254.31,-56 254.31,-96 357.08,-96 357.08,-56 254.31,-56"></polygon>
</g>
<g id="clust3" class="cluster">
<title>cluster_c3</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="254.31,-8 254.31,-48 357.08,-48 357.08,-8 254.31,-8"></polygon>
</g>
<g id="clust10" class="cluster">
<title>cluster_b4</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="131.54,-8 131.54,-48 234.31,-48 234.31,-8 131.54,-8"></polygon>
</g>
<g id="clust8" class="cluster">
<title>cluster_b2</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="131.54,-104 131.54,-144 234.31,-144 234.31,-104 131.54,-104"></polygon>
</g>
<g id="clust11" class="cluster">
<title>cluster_a1</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8,-104 8,-144 111.54,-144 111.54,-104 8,-104"></polygon>
</g>
<g id="clust7" class="cluster">
<title>cluster_b1</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8.38,-8 8.38,-48 111.15,-48 111.15,-8 8.38,-8"></polygon>
</g>
<g id="clust6" class="cluster">
<title>cluster_c6</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="377.08,-8 377.08,-48 479.85,-48 479.85,-8 377.08,-8"></polygon>
</g>
<g id="clust5" class="cluster">
<title>cluster_c5</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="377.08,-56 377.08,-96 479.85,-96 479.85,-56 377.08,-56"></polygon>
</g>
<g id="clust12" class="cluster">
<title>cluster_a2</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8,-56 8,-96 111.54,-96 111.54,-56 8,-56"></polygon>
</g>
<g id="clust4" class="cluster">
<title>cluster_c4</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="377.08,-104 377.08,-144 479.85,-144 479.85,-104 377.08,-104"></polygon>
</g>
<g id="clust9" class="cluster">
<title>cluster_b3</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="131.54,-56 131.54,-96 234.31,-96 234.31,-56 131.54,-56"></polygon>
</g>
<!-- TestClassB1 -->
<g id="node1" class="node">
<title>TestClassB1</title>
<polygon fill="lightgreen" stroke="black" points="103.04,-40.3 16.5,-40.3 16.5,-15.7 103.04,-15.7 103.04,-40.3"></polygon>
<text text-anchor="middle" x="59.77" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassB1</text>
</g>
<!-- TestClassB4 -->
<g id="node2" class="node">
<title>TestClassB4</title>
<polygon fill="lightgreen" stroke="black" points="226.2,-40.3 139.65,-40.3 139.65,-15.7 226.2,-15.7 226.2,-40.3"></polygon>
<text text-anchor="middle" x="182.93" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassB4</text>
</g>
<!-- TestClassB1&#45;&gt;TestClassB4 -->
<g id="edge1" class="edge">
<title>TestClassB1-&gt;TestClassB4</title>
<path fill="none" stroke="black" d="M103.14,-28C111.58,-28 120.54,-28 129.27,-28"></path>
<polygon fill="black" stroke="black" points="129.37,-31.5 139.37,-28 129.37,-24.5 129.37,-31.5"></polygon>
</g>
<!-- TestClassC3 -->
<g id="node3" class="node">
<title>TestClassC3</title>
<polygon fill="lightblue" stroke="black" points="348.97,-40.3 262.42,-40.3 262.42,-15.7 348.97,-15.7 348.97,-40.3"></polygon>
<text text-anchor="middle" x="305.7" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC3</text>
</g>
<!-- TestClassB4&#45;&gt;TestClassC3 -->
<g id="edge2" class="edge">
<title>TestClassB4-&gt;TestClassC3</title>
<path fill="none" stroke="black" d="M226.5,-28C234.71,-28 243.4,-28 251.89,-28"></path>
<polygon fill="black" stroke="black" points="252.09,-31.5 262.09,-28 252.09,-24.5 252.09,-31.5"></polygon>
</g>
<!-- TestClassC6 -->
<g id="node4" class="node">
<title>TestClassC6</title>
<polygon fill="lightblue" stroke="black" points="471.74,-40.3 385.19,-40.3 385.19,-15.7 471.74,-15.7 471.74,-40.3"></polygon>
<text text-anchor="middle" x="428.47" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC6</text>
</g>
<!-- TestClassC3&#45;&gt;TestClassC6 -->
<g id="edge3" class="edge">
<title>TestClassC3-&gt;TestClassC6</title>
<path fill="none" stroke="black" d="M349.27,-28C357.48,-28 366.17,-28 374.66,-28"></path>
<polygon fill="black" stroke="black" points="374.86,-31.5 384.86,-28 374.86,-24.5 374.86,-31.5"></polygon>
</g>
<!-- TestClassA2 -->
<g id="node5" class="node">
<title>TestClassA2</title>
<polygon fill="lightpink" stroke="black" points="103.31,-88.3 16.23,-88.3 16.23,-63.7 103.31,-63.7 103.31,-88.3"></polygon>
<text text-anchor="middle" x="59.77" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassA2</text>
</g>
<!-- TestClassB3 -->
<g id="node6" class="node">
<title>TestClassB3</title>
<polygon fill="lightgreen" stroke="black" points="226.2,-88.3 139.65,-88.3 139.65,-63.7 226.2,-63.7 226.2,-88.3"></polygon>
<text text-anchor="middle" x="182.93" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassB3</text>
</g>
<!-- TestClassA2&#45;&gt;TestClassB3 -->
<g id="edge4" class="edge">
<title>TestClassA2-&gt;TestClassB3</title>
<path fill="none" stroke="black" d="M103.48,-76C111.91,-76 120.84,-76 129.53,-76"></path>
<polygon fill="black" stroke="black" points="129.6,-79.5 139.6,-76 129.6,-72.5 129.6,-79.5"></polygon>
</g>
<!-- TestClassC2 -->
<g id="node7" class="node">
<title>TestClassC2</title>
<polygon fill="lightblue" stroke="black" points="348.97,-88.3 262.42,-88.3 262.42,-63.7 348.97,-63.7 348.97,-88.3"></polygon>
<text text-anchor="middle" x="305.7" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassC2</text>
</g>
<!-- TestClassB3&#45;&gt;TestClassC2 -->
<g id="edge5" class="edge">
<title>TestClassB3-&gt;TestClassC2</title>
<path fill="none" stroke="black" d="M226.5,-76C234.71,-76 243.4,-76 251.89,-76"></path>
<polygon fill="black" stroke="black" points="252.09,-79.5 262.09,-76 252.09,-72.5 252.09,-79.5"></polygon>
</g>
<!-- TestClassC5 -->
<g id="node8" class="node">
<title>TestClassC5</title>
<polygon fill="lightblue" stroke="black" points="471.74,-88.3 385.19,-88.3 385.19,-63.7 471.74,-63.7 471.74,-88.3"></polygon>
<text text-anchor="middle" x="428.47" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassC5</text>
</g>
<!-- TestClassC2&#45;&gt;TestClassC5 -->
<g id="edge6" class="edge">
<title>TestClassC2-&gt;TestClassC5</title>
<path fill="none" stroke="black" d="M349.27,-76C357.48,-76 366.17,-76 374.66,-76"></path>
<polygon fill="black" stroke="black" points="374.86,-79.5 384.86,-76 374.86,-72.5 374.86,-79.5"></polygon>
</g>
<!-- TestClassA1 -->
<g id="node9" class="node">
<title>TestClassA1</title>
<polygon fill="lightpink" stroke="black" points="103.31,-136.3 16.23,-136.3 16.23,-111.7 103.31,-111.7 103.31,-136.3"></polygon>
<text text-anchor="middle" x="59.77" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassA1</text>
</g>
<!-- TestClassB2 -->
<g id="node10" class="node">
<title>TestClassB2</title>
<polygon fill="lightgreen" stroke="black" points="226.2,-136.3 139.65,-136.3 139.65,-111.7 226.2,-111.7 226.2,-136.3"></polygon>
<text text-anchor="middle" x="182.93" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassB2</text>
</g>
<!-- TestClassA1&#45;&gt;TestClassB2 -->
<g id="edge7" class="edge">
<title>TestClassA1-&gt;TestClassB2</title>
<path fill="none" stroke="black" d="M103.48,-124C111.91,-124 120.84,-124 129.53,-124"></path>
<polygon fill="black" stroke="black" points="129.6,-127.5 139.6,-124 129.6,-120.5 129.6,-127.5"></polygon>
</g>
<!-- TestClassC1 -->
<g id="node11" class="node">
<title>TestClassC1</title>
<polygon fill="lightblue" stroke="black" points="348.97,-136.3 262.42,-136.3 262.42,-111.7 348.97,-111.7 348.97,-136.3"></polygon>
<text text-anchor="middle" x="305.7" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassC1</text>
</g>
<!-- TestClassB2&#45;&gt;TestClassC1 -->
<g id="edge8" class="edge">
<title>TestClassB2-&gt;TestClassC1</title>
<path fill="none" stroke="black" d="M226.5,-124C234.71,-124 243.4,-124 251.89,-124"></path>
<polygon fill="black" stroke="black" points="252.09,-127.5 262.09,-124 252.09,-120.5 252.09,-127.5"></polygon>
</g>
<!-- TestClassC4 -->
<g id="node12" class="node">
<title>TestClassC4</title>
<polygon fill="lightblue" stroke="black" points="471.74,-136.3 385.19,-136.3 385.19,-111.7 471.74,-111.7 471.74,-136.3"></polygon>
<text text-anchor="middle" x="428.47" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassC4</text>
</g>
<!-- TestClassC1&#45;&gt;TestClassC4 -->
<g id="edge9" class="edge">
<title>TestClassC1-&gt;TestClassC4</title>
<path fill="none" stroke="black" d="M349.27,-124C357.48,-124 366.17,-124 374.66,-124"></path>
<polygon fill="black" stroke="black" points="374.86,-127.5 384.86,-124 374.86,-120.5 374.86,-127.5"></polygon>
</g>
</g>
</svg>

</center>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial Execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Module Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Static Class Sharding</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time Taken</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>4</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>12</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here we have shortened the time taken further, from 6 sequential test suites to just 4. However, it has
come at the cost of spawning significantly more processes, as each 1-testclass group
is allocated its own process.</p>
</div>
<div class="paragraph">
<p>Our practical benchmarks reflect this change as well:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial Execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Module Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Static Class Sharding</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Netty unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>51s</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mill scalalib tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">502s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">477s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>181s</strong></p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>The Netty unit test benchmark has lots of small fast test classes, and so spawning a process for each test
class is very expensive. We see the time taken to run all tests ballooning from 10s to 51s, as
any improvement in parallelism is dominated by the cost of spawning the additional processes</p>
</li>
<li>
<p>For the Mill scalalib test benchmark which has slow test classes that take ~10 seconds each,
spawning a process for each test class is a much smaller cost. And so the increased parallelism is able
to provide a 2-3x speedup</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The basic problem with static test sharding is that the ideal sharding depends on the
runtime characteristics of your test suite.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Small, fast test classes would benefit from having a coarse-grained sharding
with many test classes per group. This amortizes the cost of spawning a process,
while there are enough test classes that even a coarse-grained grouping would provide
plenty of opportunities for parallelism</p>
</li>
<li>
<p>Large, slow test classes would prefer a fine-grained sharding with only one
test class per group. This maximizes parallelism, while the cost of spawning processes
is small compared to the cost of running even a single test class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Figuring out the ideal sharding for
a given test suite can only be figured out experimentally, and
keeping the sharding optimal as the test suite evolves over time is basically impossible.
And as you can see from the numbers above, static sharding could easily make
things worse if mis-configured!</p>
</div>
<div class="paragraph">
<p>Thus although group-based parallelism serves as a reasonable band-aid for specific modules
where you can put in the effort to tune the grouping, the amount of manual tuning
and room for error means it could never be widely used or turned on by default by the build tool.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dynamic_sharding"><a class="anchor" href="#_dynamic_sharding"></a>Dynamic Sharding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To try and solve the problems with static test sharding,
<a href="https://github.com/com-lihaoyi/mill/pull/4614">mill#4614</a> by @HollandDM introduced dynamic sharding
using a process pool. This is opt-in via <code>def testParallelism = true</code> in Mill <code>0.12.9</code>,
and will become the default in the next major version Mill <code>0.13.0</code>.</p>
</div>
<div class="paragraph">
<p>The idea of dynamic sharding is that you never had more the <code>NUM_CPUS</code> tests running
in parallel anyway, so you could just spawn <code>NUM_CPUS</code> child processes and have
those processes pull tests off a queue and run them until the queue is empty.
This meant the JVM startup overhead was proportional to <code>NUM_CPUS</code> rather than <code>NUM_TESTS</code>,
a much smaller number resulting in much smaller JVM overhead overall.</p>
</div>
<div class="paragraph">
<p>One caveat is that test classes from different modules do still need different processes
for isolation.
So if a process is available to run a test class but the process was spawned
from a different module as that test class, the process will need to be shut down and
a new one created for the new test class’s module.</p>
</div>
<div class="paragraph">
<p>If you consider this approach on our theoretical example, the execution looks something like this:</p>
</div>
<div class="paragraph">
<center>
<svg width="496px" height="160px" viewBox="0.00 0.00 495.85 160.00" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 156.0)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-156 491.85,-156 491.85,4 -4,4"></polygon>
<g id="clust3" class="cluster">
<title>cluster_c3</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="254.31,-8 254.31,-48 479.85,-48 479.85,-8 254.31,-8"></polygon>
</g>
<g id="clust4" class="cluster">
<title>cluster_b1</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8.38,-8 8.38,-48 234.31,-48 234.31,-8 8.38,-8"></polygon>
</g>
<g id="clust5" class="cluster">
<title>cluster_b2</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="131.54,-104 131.54,-144 234.31,-144 234.31,-104 131.54,-104"></polygon>
</g>
<g id="clust6" class="cluster">
<title>cluster_b3</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="131.54,-56 131.54,-96 234.31,-96 234.31,-56 131.54,-56"></polygon>
</g>
<g id="clust1" class="cluster">
<title>cluster_c1</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="254.31,-104 254.31,-144 479.85,-144 479.85,-104 254.31,-104"></polygon>
</g>
<g id="clust2" class="cluster">
<title>cluster_c2</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="254.31,-56 254.31,-96 479.85,-96 479.85,-56 254.31,-56"></polygon>
</g>
<g id="clust7" class="cluster">
<title>cluster_a1</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8,-104 8,-144 111.54,-144 111.54,-104 8,-104"></polygon>
</g>
<g id="clust8" class="cluster">
<title>cluster_a2</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8,-56 8,-96 111.54,-96 111.54,-56 8,-56"></polygon>
</g>
<!-- TestClassB1 -->
<g id="node1" class="node">
<title>TestClassB1</title>
<polygon fill="lightgreen" stroke="black" points="103.04,-40.3 16.5,-40.3 16.5,-15.7 103.04,-15.7 103.04,-40.3"></polygon>
<text text-anchor="middle" x="59.77" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassB1</text>
</g>
<!-- TestClassB4 -->
<g id="node2" class="node">
<title>TestClassB4</title>
<polygon fill="lightgreen" stroke="black" points="226.2,-40.3 139.65,-40.3 139.65,-15.7 226.2,-15.7 226.2,-40.3"></polygon>
<text text-anchor="middle" x="182.93" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassB4</text>
</g>
<!-- TestClassB1&#45;&gt;TestClassB4 -->
<g id="edge1" class="edge">
<title>TestClassB1-&gt;TestClassB4</title>
<path fill="none" stroke="black" d="M103.14,-28C111.58,-28 120.54,-28 129.27,-28"></path>
<polygon fill="black" stroke="black" points="129.37,-31.5 139.37,-28 129.37,-24.5 129.37,-31.5"></polygon>
</g>
<!-- TestClassC3 -->
<g id="node3" class="node">
<title>TestClassC3</title>
<polygon fill="lightblue" stroke="black" points="348.97,-40.3 262.42,-40.3 262.42,-15.7 348.97,-15.7 348.97,-40.3"></polygon>
<text text-anchor="middle" x="305.7" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC3</text>
</g>
<!-- TestClassB4&#45;&gt;TestClassC3 -->
<g id="edge2" class="edge">
<title>TestClassB4-&gt;TestClassC3</title>
<path fill="none" stroke="black" d="M226.5,-28C234.71,-28 243.4,-28 251.89,-28"></path>
<polygon fill="black" stroke="black" points="252.09,-31.5 262.09,-28 252.09,-24.5 252.09,-31.5"></polygon>
</g>
<!-- TestClassC6 -->
<g id="node4" class="node">
<title>TestClassC6</title>
<polygon fill="lightblue" stroke="black" points="471.74,-40.3 385.19,-40.3 385.19,-15.7 471.74,-15.7 471.74,-40.3"></polygon>
<text text-anchor="middle" x="428.47" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC6</text>
</g>
<!-- TestClassC3&#45;&gt;TestClassC6 -->
<g id="edge3" class="edge">
<title>TestClassC3-&gt;TestClassC6</title>
<path fill="none" stroke="black" d="M349.27,-28C357.48,-28 366.17,-28 374.66,-28"></path>
<polygon fill="black" stroke="black" points="374.86,-31.5 384.86,-28 374.86,-24.5 374.86,-31.5"></polygon>
</g>
<!-- TestClassA2 -->
<g id="node5" class="node">
<title>TestClassA2</title>
<polygon fill="lightpink" stroke="black" points="103.31,-88.3 16.23,-88.3 16.23,-63.7 103.31,-63.7 103.31,-88.3"></polygon>
<text text-anchor="middle" x="59.77" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassA2</text>
</g>
<!-- TestClassB3 -->
<g id="node6" class="node">
<title>TestClassB3</title>
<polygon fill="lightgreen" stroke="black" points="226.2,-88.3 139.65,-88.3 139.65,-63.7 226.2,-63.7 226.2,-88.3"></polygon>
<text text-anchor="middle" x="182.93" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassB3</text>
</g>
<!-- TestClassA2&#45;&gt;TestClassB3 -->
<g id="edge4" class="edge">
<title>TestClassA2-&gt;TestClassB3</title>
<path fill="none" stroke="black" d="M103.48,-76C111.91,-76 120.84,-76 129.53,-76"></path>
<polygon fill="black" stroke="black" points="129.6,-79.5 139.6,-76 129.6,-72.5 129.6,-79.5"></polygon>
</g>
<!-- TestClassC2 -->
<g id="node7" class="node">
<title>TestClassC2</title>
<polygon fill="lightblue" stroke="black" points="348.97,-88.3 262.42,-88.3 262.42,-63.7 348.97,-63.7 348.97,-88.3"></polygon>
<text text-anchor="middle" x="305.7" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassC2</text>
</g>
<!-- TestClassB3&#45;&gt;TestClassC2 -->
<g id="edge5" class="edge">
<title>TestClassB3-&gt;TestClassC2</title>
<path fill="none" stroke="black" d="M226.5,-76C234.71,-76 243.4,-76 251.89,-76"></path>
<polygon fill="black" stroke="black" points="252.09,-79.5 262.09,-76 252.09,-72.5 252.09,-79.5"></polygon>
</g>
<!-- TestClassC5 -->
<g id="node8" class="node">
<title>TestClassC5</title>
<polygon fill="lightblue" stroke="black" points="471.74,-88.3 385.19,-88.3 385.19,-63.7 471.74,-63.7 471.74,-88.3"></polygon>
<text text-anchor="middle" x="428.47" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassC5</text>
</g>
<!-- TestClassC2&#45;&gt;TestClassC5 -->
<g id="edge6" class="edge">
<title>TestClassC2-&gt;TestClassC5</title>
<path fill="none" stroke="black" d="M349.27,-76C357.48,-76 366.17,-76 374.66,-76"></path>
<polygon fill="black" stroke="black" points="374.86,-79.5 384.86,-76 374.86,-72.5 374.86,-79.5"></polygon>
</g>
<!-- TestClassA1 -->
<g id="node9" class="node">
<title>TestClassA1</title>
<polygon fill="lightpink" stroke="black" points="103.31,-136.3 16.23,-136.3 16.23,-111.7 103.31,-111.7 103.31,-136.3"></polygon>
<text text-anchor="middle" x="59.77" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassA1</text>
</g>
<!-- TestClassB2 -->
<g id="node10" class="node">
<title>TestClassB2</title>
<polygon fill="lightgreen" stroke="black" points="226.2,-136.3 139.65,-136.3 139.65,-111.7 226.2,-111.7 226.2,-136.3"></polygon>
<text text-anchor="middle" x="182.93" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassB2</text>
</g>
<!-- TestClassA1&#45;&gt;TestClassB2 -->
<g id="edge7" class="edge">
<title>TestClassA1-&gt;TestClassB2</title>
<path fill="none" stroke="black" d="M103.48,-124C111.91,-124 120.84,-124 129.53,-124"></path>
<polygon fill="black" stroke="black" points="129.6,-127.5 139.6,-124 129.6,-120.5 129.6,-127.5"></polygon>
</g>
<!-- TestClassC1 -->
<g id="node11" class="node">
<title>TestClassC1</title>
<polygon fill="lightblue" stroke="black" points="348.97,-136.3 262.42,-136.3 262.42,-111.7 348.97,-111.7 348.97,-136.3"></polygon>
<text text-anchor="middle" x="305.7" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassC1</text>
</g>
<!-- TestClassB2&#45;&gt;TestClassC1 -->
<g id="edge8" class="edge">
<title>TestClassB2-&gt;TestClassC1</title>
<path fill="none" stroke="black" d="M226.5,-124C234.71,-124 243.4,-124 251.89,-124"></path>
<polygon fill="black" stroke="black" points="252.09,-127.5 262.09,-124 252.09,-120.5 252.09,-127.5"></polygon>
</g>
<!-- TestClassC4 -->
<g id="node12" class="node">
<title>TestClassC4</title>
<polygon fill="lightblue" stroke="black" points="471.74,-136.3 385.19,-136.3 385.19,-111.7 471.74,-111.7 471.74,-136.3"></polygon>
<text text-anchor="middle" x="428.47" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassC4</text>
</g>
<!-- TestClassC1&#45;&gt;TestClassC4 -->
<g id="edge9" class="edge">
<title>TestClassC1-&gt;TestClassC4</title>
<path fill="none" stroke="black" d="M349.27,-124C357.48,-124 366.17,-124 374.66,-124"></path>
<polygon fill="black" stroke="black" points="374.86,-127.5 384.86,-124 374.86,-120.5 374.86,-127.5"></polygon>
</g>
</g>
</svg>

</center>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;" />
<col style="width: 20%;" />
<col style="width: 20%;" />
<col style="width: 20%;" />
<col style="width: 20%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial Execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Module Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Static Class Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Dynamic Sharding</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time Taken</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>4</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>8</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Above, you can see that first <code>A1</code>, <code>A2</code>, and <code>B1</code> are scheduled
and each assigned a process (dashed boxes). When <code>A1</code> and <code>A2</code> finish, new processes
need to be spawned to run <code>B2</code> and <code>B3</code>, but when
<code>B1</code> finishes the same process can run <code>B4</code>. Later, <code>C1</code>, <code>C2</code>,
and <code>C3</code> run, and when they finish we can re-use their processes for running
<code>C4</code>, <code>C5</code>, and <code>C6</code> respectively.</p>
</div>
<div class="paragraph">
<p>This sharing and re-use of processes is able to bring down the
number of processes spawned from 12 to 8 in our theoretical example, while preserving the
time taken at 4. However, 8 is still much more than the 3 processes that
<em>serial execution</em> or <em>module sharding</em> needed, indicating that this approach does
still add significantly process spawning overhead that the more naive approaches
we saw earlier.</p>
</div>
<div class="paragraph">
<p>This difference in the number of processes spawned reflects in the practical benchmarks below:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;" />
<col style="width: 20%;" />
<col style="width: 20%;" />
<col style="width: 20%;" />
<col style="width: 20%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial Execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Module Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Static Class Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Dynamic Sharding</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Netty unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">51s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>21s</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mill scalalib tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">502s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">477s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">181s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>160s</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here we can see that both the Netty unit test benchmark and the Mill scalalib
benchmark both show a significant speedup using <em>dynamic sharding</em> over <em>static class sharding</em>, which can
be attributed to the reduced number of processes being spawned. However,
despite the speedup, the Netty unit test benchmark is still 2x slower than the
more naive <em>module sharding</em> approach.</p>
</div>
<div class="paragraph">
<p>From the diagram above, we can see the nature of the problem: Ideally we would want
<code>A1</code> and <code>A2</code> to share one process, <code>B1</code> <code>B2</code> <code>B3</code> <code>B4</code> to share another process, etc.
But because we are scheduling test classes to run arbitrarily without regard to re-use,
each thread ends up running tests from different modules rather often, with each such
change forcing a new process to be spawned.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_biased_dynamic_sharding"><a class="anchor" href="#_biased_dynamic_sharding"></a>Biased Dynamic Sharding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last piece of the puzzle is to use <em>dynamic test sharding</em>, but to bias the Mill
scheduler to running the <em>first</em> test process for each module as soon as possible,
and <em>subsequent</em> processes only later if there were no other first-processes to run.</p>
</div>
<div class="paragraph">
<p>What biased dynamic sharding does is try to minimize the number of
processes each module’s test suite will run: If the scheduler has a choice between
spawning a second process for <code>ModuleA</code> or the first process for <code>ModuleB</code>, it should
prioritize the first process for <code>ModuleB</code>. This gives the existing first process
for <code>ModulaA</code> a chance to complete its current test class and pick up the next one,
without needing to spawn a second process and paying the cost of doing so.</p>
</div>
<div class="paragraph">
<p>Simulating this on our theoretical example, execution ends up looking like this:</p>
</div>
<div class="paragraph">
<center>
<svg width="497px" height="160px" viewBox="0.00 0.00 496.62 160.00" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.0 1.0) rotate(0.0) translate(4.0 156.0)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-156 492.62,-156 492.62,4 -4,4"></polygon>
<g id="clust4" class="cluster">
<title>cluster_c5</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="255.08,-104 255.08,-144 480.62,-144 480.62,-104 255.08,-104"></polygon>
</g>
<g id="clust1" class="cluster">
<title>cluster_c1</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8.38,-8 8.38,-48 480.62,-48 480.62,-8 8.38,-8"></polygon>
</g>
<g id="clust2" class="cluster">
<title>cluster_b1</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8.38,-56 8.38,-96 480.62,-96 480.62,-56 8.38,-56"></polygon>
</g>
<g id="clust3" class="cluster">
<title>cluster_a1</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8,-104 8,-144 235.08,-144 235.08,-104 8,-104"></polygon>
</g>
<!-- TestClassC1 -->
<g id="node1" class="node">
<title>TestClassC1</title>
<polygon fill="lightblue" stroke="black" points="103.04,-40.3 16.5,-40.3 16.5,-15.7 103.04,-15.7 103.04,-40.3"></polygon>
<text text-anchor="middle" x="59.77" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC1</text>
</g>
<!-- TestClassC2 -->
<g id="node2" class="node">
<title>TestClassC2</title>
<polygon fill="lightblue" stroke="black" points="226.58,-40.3 140.04,-40.3 140.04,-15.7 226.58,-15.7 226.58,-40.3"></polygon>
<text text-anchor="middle" x="183.31" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC2</text>
</g>
<!-- TestClassC1&#45;&gt;TestClassC2 -->
<g id="edge7" class="edge">
<title>TestClassC1-&gt;TestClassC2</title>
<path fill="none" stroke="black" d="M103.28,-28C111.84,-28 120.93,-28 129.79,-28"></path>
<polygon fill="black" stroke="black" points="130.03,-31.5 140.03,-28 130.03,-24.5 130.03,-31.5"></polygon>
</g>
<!-- TestClassC3 -->
<g id="node3" class="node">
<title>TestClassC3</title>
<polygon fill="lightblue" stroke="black" points="349.74,-40.3 263.19,-40.3 263.19,-15.7 349.74,-15.7 349.74,-40.3"></polygon>
<text text-anchor="middle" x="306.47" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC3</text>
</g>
<!-- TestClassC2&#45;&gt;TestClassC3 -->
<g id="edge8" class="edge">
<title>TestClassC2-&gt;TestClassC3</title>
<path fill="none" stroke="black" d="M226.68,-28C235.12,-28 244.08,-28 252.81,-28"></path>
<polygon fill="black" stroke="black" points="252.91,-31.5 262.91,-28 252.91,-24.5 252.91,-31.5"></polygon>
</g>
<!-- TestClassC4 -->
<g id="node4" class="node">
<title>TestClassC4</title>
<polygon fill="lightblue" stroke="black" points="472.51,-40.3 385.96,-40.3 385.96,-15.7 472.51,-15.7 472.51,-40.3"></polygon>
<text text-anchor="middle" x="429.24" y="-23.8" font-family="Times,serif" font-size="14.00">TestClassC4</text>
</g>
<!-- TestClassC3&#45;&gt;TestClassC4 -->
<g id="edge9" class="edge">
<title>TestClassC3-&gt;TestClassC4</title>
<path fill="none" stroke="black" d="M350.04,-28C358.25,-28 366.94,-28 375.43,-28"></path>
<polygon fill="black" stroke="black" points="375.63,-31.5 385.63,-28 375.63,-24.5 375.63,-31.5"></polygon>
</g>
<!-- TestClassB1 -->
<g id="node5" class="node">
<title>TestClassB1</title>
<polygon fill="lightgreen" stroke="black" points="103.04,-88.3 16.5,-88.3 16.5,-63.7 103.04,-63.7 103.04,-88.3"></polygon>
<text text-anchor="middle" x="59.77" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassB1</text>
</g>
<!-- TestClassB2 -->
<g id="node6" class="node">
<title>TestClassB2</title>
<polygon fill="lightgreen" stroke="black" points="226.58,-88.3 140.04,-88.3 140.04,-63.7 226.58,-63.7 226.58,-88.3"></polygon>
<text text-anchor="middle" x="183.31" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassB2</text>
</g>
<!-- TestClassB1&#45;&gt;TestClassB2 -->
<g id="edge4" class="edge">
<title>TestClassB1-&gt;TestClassB2</title>
<path fill="none" stroke="black" d="M103.28,-76C111.84,-76 120.93,-76 129.79,-76"></path>
<polygon fill="black" stroke="black" points="130.03,-79.5 140.03,-76 130.03,-72.5 130.03,-79.5"></polygon>
</g>
<!-- TestClassB3 -->
<g id="node7" class="node">
<title>TestClassB3</title>
<polygon fill="lightgreen" stroke="black" points="349.74,-88.3 263.19,-88.3 263.19,-63.7 349.74,-63.7 349.74,-88.3"></polygon>
<text text-anchor="middle" x="306.47" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassB3</text>
</g>
<!-- TestClassB2&#45;&gt;TestClassB3 -->
<g id="edge5" class="edge">
<title>TestClassB2-&gt;TestClassB3</title>
<path fill="none" stroke="black" d="M226.68,-76C235.12,-76 244.08,-76 252.81,-76"></path>
<polygon fill="black" stroke="black" points="252.91,-79.5 262.91,-76 252.91,-72.5 252.91,-79.5"></polygon>
</g>
<!-- TestClassB4 -->
<g id="node8" class="node">
<title>TestClassB4</title>
<polygon fill="lightgreen" stroke="black" points="472.51,-88.3 385.96,-88.3 385.96,-63.7 472.51,-63.7 472.51,-88.3"></polygon>
<text text-anchor="middle" x="429.24" y="-71.8" font-family="Times,serif" font-size="14.00">TestClassB4</text>
</g>
<!-- TestClassB3&#45;&gt;TestClassB4 -->
<g id="edge6" class="edge">
<title>TestClassB3-&gt;TestClassB4</title>
<path fill="none" stroke="black" d="M350.04,-76C358.25,-76 366.94,-76 375.43,-76"></path>
<polygon fill="black" stroke="black" points="375.63,-79.5 385.63,-76 375.63,-72.5 375.63,-79.5"></polygon>
</g>
<!-- TestClassA1 -->
<g id="node9" class="node">
<title>TestClassA1</title>
<polygon fill="lightpink" stroke="black" points="103.31,-136.3 16.23,-136.3 16.23,-111.7 103.31,-111.7 103.31,-136.3"></polygon>
<text text-anchor="middle" x="59.77" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassA1</text>
</g>
<!-- TestClassA2 -->
<g id="node10" class="node">
<title>TestClassA2</title>
<polygon fill="lightpink" stroke="black" points="226.85,-136.3 139.77,-136.3 139.77,-111.7 226.85,-111.7 226.85,-136.3"></polygon>
<text text-anchor="middle" x="183.31" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassA2</text>
</g>
<!-- TestClassA1&#45;&gt;TestClassA2 -->
<g id="edge1" class="edge">
<title>TestClassA1-&gt;TestClassA2</title>
<path fill="none" stroke="black" d="M103.62,-124C111.88,-124 120.63,-124 129.17,-124"></path>
<polygon fill="black" stroke="black" points="129.44,-127.5 139.44,-124 129.44,-120.5 129.44,-127.5"></polygon>
</g>
<!-- TestClassC5 -->
<g id="node11" class="node">
<title>TestClassC5</title>
<polygon fill="lightblue" stroke="black" points="349.74,-136.3 263.19,-136.3 263.19,-111.7 349.74,-111.7 349.74,-136.3"></polygon>
<text text-anchor="middle" x="306.47" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassC5</text>
</g>
<!-- TestClassA2&#45;&gt;TestClassC5 -->
<g id="edge2" class="edge">
<title>TestClassA2-&gt;TestClassC5</title>
<path fill="none" stroke="black" d="M227.02,-124C235.45,-124 244.38,-124 253.07,-124"></path>
<polygon fill="black" stroke="black" points="253.14,-127.5 263.14,-124 253.14,-120.5 253.14,-127.5"></polygon>
</g>
<!-- TestClassC6 -->
<g id="node12" class="node">
<title>TestClassC6</title>
<polygon fill="lightblue" stroke="black" points="472.51,-136.3 385.96,-136.3 385.96,-111.7 472.51,-111.7 472.51,-136.3"></polygon>
<text text-anchor="middle" x="429.24" y="-119.8" font-family="Times,serif" font-size="14.00">TestClassC6</text>
</g>
<!-- TestClassC5&#45;&gt;TestClassC6 -->
<g id="edge3" class="edge">
<title>TestClassC5-&gt;TestClassC6</title>
<path fill="none" stroke="black" d="M350.04,-124C358.25,-124 366.94,-124 375.43,-124"></path>
<polygon fill="black" stroke="black" points="375.63,-127.5 385.63,-124 375.63,-120.5 375.63,-127.5"></polygon>
</g>
</g>
</svg>

</center>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.667%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial Execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Module Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Static Class Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamic Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Biased Dynamic Sharding</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time Taken</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>4</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>4</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In the diagram above, we can see that <em>biased dynamic sharding</em> is able
to maintain the time taken at length 4, while reducing the number of processes
spawned (dashed boxes) from 8 to 4. We can see that <code>ModuleA</code> (red)
<code>ModuleB</code> (green) and <code>ModuleC</code> (blue)
are each assigned a single process to do all of its work, and only when there is a thread free
(when <code>A1</code> and <code>A2</code> have completed) is <code>ModuleC</code> given the idle thread to parallelize
its remaining test classes.</p>
</div>
<div class="paragraph">
<p>This is a strict improvement over the previous <em>dynamic sharding</em> and <em>static class sharding</em>
approaches, and it is reflected in the practical benchmarks where both Netty unit
tests and Mill scalalib tests show speedups over the previous <em>dynamic sharding</em> approach:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.667%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial Execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Module Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Static Class Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamic Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Biased Dynamic Sharding</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Netty unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">51s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>12s</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mill scalalib tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">502s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">477s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">181s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">160s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>132s</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Notably, the Netty unit tests benchmark is now comparable to the performance we were
seeing with <em>module sharding</em>! Although there is still a slight slowdown in the
practical benchmark - presumably from the slight increase in the number of spawned processes
- it is not longer the large 2-5x slowdowns we see in
<em>static class sharding</em> and <em>dynamic sharding</em>. <em>biased dynamic sharding</em> seems to finally provide
a test parallelization strategy that is flexible enough to handle widely varying workloads
without the pathological slowdowns that previous strategies exhibited.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation"><a class="anchor" href="#_implementation"></a>Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The implementation of the various parallelism strategies we discussed above isn’t complicated:
the Mill build tool is a JVM application, and all these strategies basically boil down
to passing <code>Runnable</code>s to a <code>ThreadPoolExecutor</code>, each one
using <code>ProcessBuilder</code> to spawn the test runner. Different strategies have different
levels of granularity for the <code>Runnable</code>s, and different queues for the <code>ThreadPoolExecutor</code>
(e.g. <em>biased dynamic sharding</em> using a <code>PriorityBlockingQueue</code> to bias the scheduler
towards running some tasks over others) but fundamentally there’s nothing advanced going on.</p>
</div>
<div class="paragraph">
<p>Perhaps the most interesting implementation detail is for <em>dynamic sharding</em>:
this requires the build tool to spawn a pool of test runner processes that
pull the test classes off of a queue until all test classes have been completed. Mill
implements this queue using a folder on disk containing one-file-per-test-class, which each
spawned processes simply loops over and attempts to claim them via an
<a href="https://stackoverflow.com/questions/18706419/is-a-move-operation-in-unix-atomic">Atomic Filesystem Move</a>.
This allows us to avoid the complexity of managing a third party queue system,
or dealing with RPCs between different processes via sockets or <code>memmap</code>ed files.
The simple disk-based queue is more than capable of handling the relatively
small-scale that a build tool test runner operates at (100-1000s of test classes).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_tool_comparisons"><a class="anchor" href="#_build_tool_comparisons"></a>Build Tool Comparisons</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mill is a relatively new JVM build tool, so it begs the question: how does Mill’s test
runner compare to other JVM build tools like Maven, Gradle, or SBT? For this we ran the
benchmarks above on the Mill example builds we used for our
<a href="../mill/comparisons/maven.html" class="xref page">Maven case study</a>,
<a href="../mill/comparisons/gradle.html" class="xref page">Gradle case study</a>, or
<a href="../mill/comparisons/gradle.html" class="xref page">SBT case study</a>. Although these benchmarks were
rough, they should hopefully give you a good intuition for where the strategies discussed
above fit into the larger build tool landscape.</p>
</div>
<div class="sect2">
<h3 id="_maven_comparison"><a class="anchor" href="#_maven_comparison"></a>Maven Comparison</h3>
<div class="paragraph">
<p>The Netty project we’ve been discussing in this article
is normally built using Maven: the Mill build is non-standard
and used mainly as a <a href="../mill/comparisons/maven.html" class="xref page">Case Study Comparison</a>,
but that gives us an opportunity to run these benchmarks using Maven to see how
it compares to the strategies discussed above. To run the same subset of unit test suites using Maven that we
ran using Mill in the above examples, we used these commands, resulting in the following
timings for various testing strategies:</p>
</div>
<div class="listingblock">
<div class="title">Maven Serial</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">&gt; ./mvnw -pl codec-dns,codec-haproxy,codec-http,codec-http2,codec-memcache,codec-mqtt,codec-redis,codec-smtp,codec-socks,codec-stomp,codec-xml,transport-blockhound-tests,transport-native-unix-common,transport-sctp test</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Maven Parallel</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">&gt; ./mvnw -T 10 -pl codec-dns,codec-haproxy,codec-http,codec-http2,codec-memcache,codec-mqtt,codec-redis,codec-smtp,codec-socks,codec-stomp,codec-xml,transport-blockhound-tests,transport-native-unix-common,transport-sctp test</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.667%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mill</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial Execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Module Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Static Class Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamic Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Biased Dynamic Sharding</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Netty unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">51s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>12s</strong></p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;" />
<col style="width: 33.3333%;" />
<col style="width: 33.3334%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maven</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Parallel</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Netty unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">36s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>15s</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here we can see that the Mill parallel testing strategy has some speedups over the
<a href="https://maven.apache.org/">Maven</a> build using the
<a href="https://maven.apache.org/surefire/maven-surefire-plugin/">Maven-Surefire-Plugin</a>.
For the purposes of this comparison, we did not manage to get further speedups from setting
the Maven-Surefire-Plugin’s internal parallelism configuration
(<a href="https://maven.apache.org/surefire/maven-surefire-plugin/examples/fork-options-and-parallel-execution.html">link</a>),
and so did not include that in the table above.</p>
</div>
</div>
<div class="sect2">
<h3 id="_gradle_comparison"><a class="anchor" href="#_gradle_comparison"></a>Gradle Comparison</h3>
<div class="paragraph">
<p>For another data point, we repeated the same benchmarks on the
<a href="https://github.com/mockito/mockito">Mockito</a> codebase. Mockito is a popular mocking framework
for JVM unit tests, and its
codebase is built using Gradle. Like Netty, we have an example Mill build for Mockito
as a <a href="../mill/comparisons/gradle.html" class="xref page">Case Study Comparison</a>, which although
not 100% complete can serve to let us compare the Mill test parallelism strategies to that
of Gradle. The commands used to run the subset of the Mockito build that works on both
Mill and Gradle are shown below, along with the timings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ ./mill test + subprojects.android.test + subprojects.errorprone.test + subprojects.extTest.test + subprojects.inlineTest.test + subprojects.junit-jupiter.test + subprojects.junitJupiterExtensionTest.test + subprojects.junitJupiterInlineMockMakerExtensionTest.test + subprojects.junitJupiterParallelTest.test + subprojects.memory-test.test + subprojects.programmatic-test.test + subprojects.proxy.test + subprojects.subclass.test

$ ./gradlew cleanTest &amp;&amp; ./gradlew :test android:test errorprone:test extTest:test inlineTest:test junit-jupiter:test junitJupiterExtensionTest:test junitJupiterInlineMockMakerExtensionTest:test junitJupiterParallelTest:test memory-test:test programmatic-test:test proxy:test subclass:test</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.667%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mill</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial Execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Module Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Static Class Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamic Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Biased Dynamic Sharding</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mockito unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">62s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">47s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">139s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>21s</strong></p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gradle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parallel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Parallel + maxParallelForks</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mockito unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">90s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">56s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>31s</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <em>Gradle Serial</em> and <em>Gradle Parallel</em> benchmarks were run with <code>org.gradle.parallel</code>
configured accordingly: <em>Gradle Serial</em> is similar to Mill’s <em>serial execution</em>,
while <em>Gradle Parallel</em> is similar to Mill’s <em>module sharding</em> strategies. Enabling
<a href="https://docs.gradle.org/current/userguide/performance.html#execute_tests_in_parallel">maxParallelForks</a>
in Gradle to parallelize the tests within a subproject improves performance significantly,
with numbers comparable to Mill’s <em>dynamic sharding</em>, although it is still significantly
slower than Mill’s <em>biased dynamic sharding</em> strategy. From the numbers I would assume
that Gradle’s parallelism approach is similar to Mill’s <em>dynamic sharding</em>, but it doesn’t
have the same process-spawning optimizations that Mill does in its <em>biased dynamic sharding</em>
strategy</p>
</div>
</div>
<div class="sect2">
<h3 id="_sbt_comparison"><a class="anchor" href="#_sbt_comparison"></a>SBT Comparison</h3>
<div class="paragraph">
<p>As a last comparison, we repeated these testing benchmarks on the
<a href="https://github.com/gatling/gatling">Gatling</a> codebase. Gatling is a popular load testing
tool written in Scala and built using SBT, and we have an example Mill build
for it as a <a href="../mill/comparisons/sbt.html" class="xref page">Case Study Comparison</a>.
We can run the tests for both Mill and SBT builds for Gatling using the following command,
and repeating the benchmarks gives us the timings below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ ./mill __.test
$ sbt test</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.6666%;" />
<col style="width: 16.667%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mill</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial Execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Module Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Static Class Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamic Sharding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Biased Dynamic Sharding</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gatling unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">27s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">38s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>12s</strong></p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;" />
<col style="width: 33.3333%;" />
<col style="width: 33.3334%;" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SBT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serial</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Parallel</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gatling unit tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>12s</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>SBT Serial</em> is run with <code>fork := true</code> spawning a process to run tests,
while <em>SBT Parallel</em> is run with <code>fork := false</code> running tests in the shared JVM process.
Here we can see that for this benchmark, SBT’s in-memory parallel test running has
similar performance to Mill’s <em>biased dynamic sharding</em>. Although the Mill test runner isn’t
faster, it does have nice properties: running the tests in subprocesses in sandbox folders
provides a greater degree of isolation between the concurrent tests, which mitigates the
risk of inter-test interference. Perhaps more importantly, Mill’s <code>testParallelism</code>
is relatively self-tuning and should generally &quot;just work&quot; once enabled, whereas SBT
has a number of different flags (<code>parallelExecution</code>, <code>concurrencyRestriction</code>, <code>fork</code>,
<code>testForkedParallel</code>) that need to be configured together which can be tedious and
error-prone.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion"><a class="anchor" href="#_conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It’s interesting how similar the problem of parallelizing tests is to the challenge of
architecting any distributed system. The ideas of <em>static sharding</em> and <em>dynamic
sharding</em> should be familiar to any backend or infrastructure engineer, and the same
tradeoffs that apply to their use in backend systems also apply to their use in a build tool’s
test runner. It’s also surprising how much detail there is when trying to &quot;parallelize unit
tests&quot;: not only throwing the work at a thread or process-pool, but also managing the lifetimes,
re-use, and scheduling of heavyweight JVM test processes in order to provide good performance
across a wide variety of workloads.</p>
</div>
<div class="paragraph">
<p>The Mill build tool’s test parallelism strategy has gone through a lot of iterations and
improvement over the years, but at this point it is in a pretty good state.
Most importantly, Mill’s new <code>def testParallelism = true</code> flag is a single switch.
It is not that much <em>faster</em> than running tests with older strategies or other
build tools, but it provides that performance across a wide range of workloads without needing
manual tuning or configuration. This simplifies the user experience,
letting them spend less time fiddling with the build tool and more time focusing on their actual
project. While <code>testParallelism</code> it is opt-in for testing in the latest Mill <code>0.12.9</code>,
we expect to make it the default (with an opt-out) in the next major version of Mill <code>0.13.0</code>.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="12-direct-style-build-tool.html">Mill as a Direct Style Build Tool</a></span>
  <span class="next"><a href="10-bytecode-callgraph-analysis.html">Invalidating build caches using JVM bytecode callgraph analysis</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async="async" src="../_/js/vendor/highlight.js"></script>
<script src="../_/js/vendor/lunr.js"></script>
<script src="../_/js/search-ui.js" id="search-ui-script" data-site-root-path=".." data-snippet-length="100" data-stylesheet="../_/css/search.css"></script>
<script async="async" src="../search-index.js"></script>
  
</body></html>