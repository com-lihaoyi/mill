on:
  workflow_call:
    inputs:
      compileargs:
        default: '__.compile'
        type: string
      java-version:
        default: '11'
        type: string
      os:
        type: string
      timeout-minutes:
        default: 60
        type: number

      shell:
        required: true
        type: string

jobs:
  run:
    runs-on: ${{ inputs.os }}
    timeout-minutes: ${{ inputs.timeout-minutes }}
    steps:
      # For normal PR jobs, just checkout the base_ref the PR is against
      - uses: actions/checkout@v4
        with: { fetch-depth: 1 }
      # For normal PR jobs, just checkout the base_ref the PR is against
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
        if: ${{ !(github.event_name == 'push' && github.repository != 'com-lihaoyi/mill') }}

      # For fork push jobs, first checkout the version being pushed, then look for the
      # merge-base where the current version forks off from the upstream main branch
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
        if: ${{ github.event_name == 'push' && github.repository != 'com-lihaoyi/mill' }}

      - run: |
          git fetch https://github.com/com-lihaoyi/mill main
          MERGE_BASE=$(git merge-base FETCH_HEAD HEAD)
          # pretty-print the path between the FETCH_HEAD (main), HEAD, and the merge-base
          git log --graph --pretty=format:"%h %d %ar %s %n" --ancestry-path $MERGE_BASE^1..HEAD --ancestry-path $MERGE_BASE^1..FETCH_HEAD
          
          git checkout $MERGE_BASE
        shell: bash
        if: ${{ github.event_name == 'push' && github.repository != 'com-lihaoyi/mill' }}

      - run: echo temurin:${{ inputs.java-version }} > .mill-jvm-version
        shell: bash

      - run: chmod -R 777 . # normalize permissions before and after upload/download-artifact
        shell: bash

      - run: mkdir out && touch out/mill-selective-execution.json
        shell: bash

      - run: cat .mill-jvm-version
        shell: bash

      - run: ./mill -i --debug -k selective.prepare ${{ inputs.prepareargs }}
        if: ${{ (github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'run-all-tests')) || github.repository != 'com-lihaoyi/mill' }}
        shell: bash


      - run: cat out/mill-build/methodCodeHashSignatures.dest/current/4-methodCodeHashes.json | jq '.["build_.dist.package_$native$.$anonfun$executableRaw$8(os.Path,scala.collection.immutable.Seq,java.io.OutputStream)void"]'
        shell: bash
      - run: cat out/mill-build/methodCodeHashSignatures.dest/current/7-transitiveCallGraphHashes.json  | jq '.["build_.dist.package_$native$.$anonfun$executableRaw$8(os.Path,scala.collection.immutable.Seq,java.io.OutputStream)void"]'
        shell: bash
      - run: cat out/mill-build/methodCodeHashSignatures.json  | jq '.["value"]["build_.dist.package_$native$.$anonfun$executableRaw$8(os.Path,scala.collection.immutable.Seq,java.io.OutputStream)void"]'
        shell: bash
      - run: cat out/mill-selective-execution.json  | jq '.["methodCodeHashSignatures"]["build_.dist.package_$native$.$anonfun$executableRaw$8(os.Path,scala.collection.immutable.Seq,java.io.OutputStream)void"]'
        shell: bash

      - uses: actions/upload-artifact@v4.6.0
        with:
          path: out/mill-selective-execution.json
          name: ${{ inputs.os }}-selective-execution-artifact
          include-hidden-files: true

      - uses: actions/checkout@v4
      - run: ./mill -i --debug -k version


      - run: cat out/mill-build/methodCodeHashSignatures.dest/current/4-methodCodeHashes.json | jq '.["build_.dist.package_$native$.$anonfun$executableRaw$8(os.Path,scala.collection.immutable.Seq,java.io.OutputStream)void"]'
      - run: cat out/mill-build/methodCodeHashSignatures.dest/current/7-transitiveCallGraphHashes.json  | jq '.["build_.dist.package_$native$.$anonfun$executableRaw$8(os.Path,scala.collection.immutable.Seq,java.io.OutputStream)void"]'
      - run: cat out/mill-build/methodCodeHashSignatures.json  | jq '.["value"]["build_.dist.package_$native$.$anonfun$executableRaw$8(os.Path,scala.collection.immutable.Seq,java.io.OutputStream)void"]'
      - run: cat out/mill-selective-execution.json  | jq '.["methodCodeHashSignatures"]["build_.dist.package_$native$.$anonfun$executableRaw$8(os.Path,scala.collection.immutable.Seq,java.io.OutputStream)void"]'

      - uses: actions/download-artifact@v4
        with:
          path: out/mill-selective-execution
          name: ${{ inputs.os }}-selective-execution-artifact

      - run: mv out/mill-selective-execution/mill-selective-execution.json out/mill-selective-execution.json
        shell: bash
        
      - run: chmod -R 777 . # normalize permissions before and after upload/download-artifact
      - run: ./mill -i --debug -k selective.resolve 'example.javalib.basic[1-simple].native.server.test'
      - run: ./mill -i --debug -k selective.resolveTree 'example.javalib.basic[1-simple].native.server.test'
      - run: ./mill -i --debug -k selective.resolveChanged 'example.javalib.basic[1-simple].native.server.test'