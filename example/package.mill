package build.example
// imports
import scala.util.chaining.*
import coursier.maven.MavenRepository
import mill.*
import mill.util.Tasks
import mill.scalalib.*
import mill.javalib.api.JvmWorkerUtil
import mill.scalalib.publish.*
import mill.util.Jvm
import mill.api.SelectMode
import mill.contrib.buildinfo.BuildInfo
import mill.T
import mill.api.Cross
import mill.api.BuildCtx
import mill.javalib.testrunner.TestResult
import mill.testkit.Chunk
import millbuild.Deps

import java.util.concurrent.atomic.AtomicInteger

object `package` extends Module {
  def exampleModules: Seq[ExampleCrossModule] = moduleInternal
    .modules
    .collect { case m: ExampleCrossModule => m }

  object androidlib extends Module {
    object java extends Cross[ExampleCrossModuleAndroid](build.listCross)
    object kotlin extends Cross[ExampleCrossModuleAndroid](build.listCross)
  }
  object javalib extends Module {

    object basic extends Cross[ExampleCrossModuleJava](build.listCross)
    object module extends Cross[ExampleCrossModuleJava](build.listCross)
    object dependencies extends Cross[ExampleCrossModuleJava](build.listCross)
    object testing extends Cross[ExampleCrossModuleJava](build.listCross)
    object linting extends Cross[ExampleCrossModuleJava](build.listCross)
    object packaging extends Cross[ExampleCrossModuleJava](build.listCross)
    object publishing extends Cross[ExampleCrossModuleJava](build.listCross)
    object script extends Cross[ExampleCrossModuleJava](build.listCross)
    object web extends Cross[ExampleCrossModuleJava](build.listCross)
    object springboot extends Cross[ExampleCrossModule](build.listCross)
  }
  object kotlinlib extends Module {
    object basic extends Cross[ExampleCrossModuleKotlin](build.listCross)
    object module extends Cross[ExampleCrossModuleKotlin](build.listCross)
    object dependencies extends Cross[ExampleCrossModuleKotlin](build.listCross)
    object testing extends Cross[ExampleCrossModuleKotlin](build.listCross)
    object linting extends Cross[ExampleCrossModuleKotlin](build.listCross)
    object packaging extends Cross[ExampleCrossModuleKotlin](build.listCross)
    object publishing extends Cross[ExampleCrossModuleKotlin](build.listCross)
    object script extends Cross[ExampleCrossModuleKotlin](build.listCross)
    object web extends Cross[ExampleCrossModuleKotlin](build.listCross)
  }
  object scalalib extends Module {
    object basic extends Cross[ExampleCrossModule](build.listCross)
    object module extends Cross[ExampleCrossModule](build.listCross)
    object dependencies extends Cross[ExampleCrossModule](build.listCross)
    object testing extends Cross[ExampleCrossModule](build.listCross)
    object linting extends Cross[ExampleCrossModule](build.listCross)
    object packaging extends Cross[ExampleCrossModule](build.listCross)
    object publishing extends Cross[ExampleCrossModule](build.listCross)
    object script extends Cross[ExampleCrossModule](build.listCross)
    object web extends Cross[ExampleCrossModule](build.listCross)
    object native extends Cross[ExampleCrossModule](build.listCross)
    object spark extends Cross[ExampleCrossModule](build.listCross)
  }

  object migrating extends Module {
    object javalib extends Cross[ExampleCrossModuleMigrating](build.listCross)
    object scalalib extends Cross[ExampleCrossModuleMigrating](build.listCross)
  }
  object javascriptlib extends Module {
    object basic extends Cross[ExampleCrossModuleJavascript](build.listCross)
    object testing extends Cross[ExampleCrossModuleJavascript](build.listCross)
    object module extends Cross[ExampleCrossModuleJavascript](build.listCross)
    object dependencies extends Cross[ExampleCrossModuleJavascript](build.listCross)
    object publishing extends Cross[ExampleCrossModuleJavascript](build.listCross)
    object linting extends Cross[ExampleCrossModuleJavascript](build.listCross)
  }
  object pythonlib extends Module {
    object basic extends Cross[ExampleCrossModulePython](build.listCross)
    object dependencies extends Cross[ExampleCrossModulePython](build.listCross)
    object linting extends Cross[ExampleCrossModulePython](build.listCross)
    object publishing extends Cross[ExampleCrossModulePython](build.listCross)
    object module extends Cross[ExampleCrossModulePython](build.listCross)
    object web extends Cross[ExampleCrossModulePython](build.listCross)
    object testing extends Cross[ExampleCrossModulePython](build.listCross)
  }

  object groovylib extends Module {
    object basic extends Cross[ExampleCrossModuleGroovy](build.listCross)
    object testing extends Cross[ExampleCrossModuleGroovy](build.listCross)
  }

  object cli extends Module {
    object builtins extends Cross[ExampleCrossModule](build.listCross)
    object header extends Cross[ExampleCrossModule](build.listCross)
    object query extends Cross[ExampleCrossModule](build.listCross)
  }

  object fundamentals extends Module {
    object dependencies extends Cross[ExampleCrossModule](build.listCross)
    object tasks extends Cross[ExampleCrossModule](build.listCross)
    object modules extends Cross[ExampleCrossModule](build.listCross)
    object cross extends Cross[ExampleCrossModule](build.listCross)
    object `out-dir` extends Cross[ExampleCrossModule](build.listCross)
    object libraries extends Cross[ExampleCrossModule](build.listCross)
    object javahome extends Cross[ExampleCrossModule](build.listCross)
  }

  object depth extends Module {
    object sandbox extends Cross[ExampleCrossModule](build.listCross)
  }

  object large extends Module {

    object selective extends Cross[ExampleCrossModule](build.listCross)
    object multifile extends Cross[ExampleCrossModule](build.listCross)
    object multilang extends Cross[ExampleCrossModule](build.listCross)
  }

  object extending extends Module {
    object imports extends Cross[ExampleCrossModule](build.listCross)
    object metabuild extends Cross[ExampleCrossModule](build.listCross)
    object plugins extends Cross[ExampleCrossModule](build.listCross)
    object jvmcode extends Cross[ExampleCrossModule](build.listCross)
    object python extends Cross[ExampleCrossModule](build.listCross)
    object typescript extends Cross[ExampleCrossModule](build.listCross)
  }

  trait ExampleCrossModuleKotlin extends ExampleCrossModuleJava {
    override def selectiveInputs = Seq(sources) ++ build.libs.kotlinlib.kotlinSelectiveInputs

    override def lineTransform(line: String) = this.moduleSegments.parts.last match {
      case "2-test-suite" => line
          .replace(
            "./mill bar.test bar.BarTests.hello",
            "kotest_filter_tests='hello' kotest_filter_specs='bar.BarTests' ./mill bar.test"
          )
          .replace("compiling 1 ... source...", "Compiling 1 ... source...")
          .replace("compiling 2 ... source...", "Compiling 2 ... source...")
      case _ => line
    }
  }

  val androidSelectiveInputs = Seq(
    build.libs.androidlib.sources,
    build.libs.javalib.sources,
    build.libs.javalib.worker.sources
  ) ++ build.libs.kotlinlib.kotlinSelectiveInputs

  trait ExampleCrossModuleAndroid extends ExampleCrossModule {
    override def selectiveInputs = Seq(sources) ++ androidSelectiveInputs
    def testExclusive = true

    /**
     * Unique and even Android emulator port for this example test module.
     * Each module claims the port by incrementing the shared counter by two,
     * reserving one port for the console and one for adb.
     */
    val emulatorPort: Int = androidPortCounter.getAndAdd(2)

    override def forkEnv = super.forkEnv() ++ Map(
      "EMULATOR_PORT" -> emulatorPort.toString
    )

  }

  trait ExampleCrossModuleJava extends ExampleCrossModule {

    def upstreamCross(s: String) = s match {
      case "basic" => Some(scalalib.basic)
      case "testing" => Some(scalalib.testing)
      case "dependencies" => Some(scalalib.dependencies)
      case "module" => Some(scalalib.module)
      case "web" => Some(scalalib.web)
      case "packaging" => Some(scalalib.packaging)
      case "publishing" => Some(scalalib.publishing)
      case "script" => Some(scalalib.script)
      case _ => None
    }
    val upstreamOpt = upstreamCross(this.moduleSegments.parts.dropRight(1).last)
      .flatMap(_.valuesToModules.get(List(crossValue)))

    def testRepoSourceRoot = Task {
      os.copy(super.testRepoSourceRoot().path, Task.dest, mergeFolders = true)
      for (suffix <- Seq("build.mill")) {
        for (lines <- buildScLines() if os.exists(Task.dest / suffix)) {
          os.write.over(Task.dest / suffix, lines.mkString("\n"))
        }
      }
      PathRef(Task.dest)
    }

    def resources = upstreamOpt match {
      case None => Task { Seq(super.testRepoRoot()) }
      case Some(upstream) => Task {
          os.copy.over(super.testRepoRoot().path, Task.dest)
          val upstreamRoot = upstream.testRepoRoot().path
          val suffix = Seq("build.mill").find(s => os.exists(upstreamRoot / s)).head
          for (lines <- buildScLines()) {
            os.write.over(Task.dest / suffix, lines.mkString("\n"))
          }
          Seq(PathRef(Task.dest))
        }
    }
    def buildScLines = upstreamOpt match {
      case None => Task { None }
      case Some(upstream) => Task {
          Some {
            val upstreamRoot = upstream.testRepoSourceRoot().path
            val suffix = Seq("build.mill").find(s => os.exists(upstreamRoot / s)).head
            val upstreamLines = os.read.lines(upstream.testRepoSourceRoot().path / suffix)
            val lines = os.read.lines(super.testRepoSourceRoot().path / suffix)

            import collection.mutable
            val groupedLines = mutable.Map.empty[String, mutable.Buffer[String]]
            var current = Option.empty[String]
            lines.foreach {
              case s"//// SNIPPET:$name" =>
                current = Some(name)
                groupedLines(name) = mutable.Buffer()
              case s => current.foreach(groupedLines(_).append(lineTransform(s)))
            }

            current = None
            upstreamLines.flatMap {
              case s"//// SNIPPET:$name" =>
                if (name != "END") {
                  current = Some(name)
                  groupedLines(name)
                } else {
                  current = None
                  Nil
                }

              case s => if (current.nonEmpty) None else Some(lineTransform(s))
            }
          }
        }
    }

    def lineTransform(line: String) = line
  }

  /**
   * Counter for assigning unique ports to example test modules.
   * Each module claims a port by incrementing this counter.
   * Ports start at 10000 to avoid conflicts with common ports.
   */
  private val portCounter = new AtomicInteger(10000)

  /**
   * Counter for assigning unique Android emulator ports to example test modules.
   * Each module claims a port by incrementing this counter by two (for console and adb).
   * Ports start at 5554 which is the default starting port for Android emulators.
   */
  private val androidPortCounter = new AtomicInteger(5554)

  trait ExampleCrossModule extends build.integration.IntegrationTestModule {

    // disable scalafix because these example modules don't have sources causing it to misbehave
    def testRepoSourceRoot: T[PathRef] = Task.Source(moduleDir)
    def testRepoRoot: T[PathRef] = Task { testRepoSourceRoot() }
    def testClasspath: T[Seq[PathRef]] = localRunClasspath()
    def sources0 = Task.Sources(moduleDir)
    def sources = Task {
      sources0()
        .flatMap(pathRef => os.walk(pathRef.path))
        .filter(os.isFile)
        .filterNot(p =>
          (p.ext == "java" || p.ext == "kt") &&
            (p.segments.contains("linting") ||
              p.segments.contains("10-external-module-aliases") ||
              p.segments.contains("4-linting"))
        )
        .map(PathRef(_))
    }

    def resources = Seq(testRepoRoot())
    def runClasspath = build.libs.util.test.runClasspath()
    def localRunClasspath = build.testkit.localRunClasspath()

    /**
     * Unique port for this example test module.
     * Each module claims a port by incrementing the shared counter.
     * This ensures each example test gets a distinct port for parallel execution.
     */
    val testPort: Int = portCounter.getAndIncrement()

    def forkEnv = Map("LANG" -> "C", "PORT" -> testPort.toString)
    def forkArgs: T[Seq[String]] = Task(List.empty[String])

    /**
     * Parses a `build.mill` for specific comments and return the split-by-type content
     */
    def parsed: T[Seq[mill.testkit.Chunk]] = Task {
      mill.testkit.ExampleParser(testRepoSourceRoot().path)
    }

    def rendered = Task {
      var seenCode = false
      var seenFrontMatter = false
      val examplePath = moduleDir.subRelativeTo(BuildCtx.workspaceRoot)
      val frontMatter = parsed().takeWhile(_.isInstanceOf[Chunk.Yaml]).collect {
        case Chunk.Yaml(lines) => lines.mkString("\n")
      }.mkString("\n")
      val withoutFrontMatter = parsed().dropWhile(_.isInstanceOf[Chunk.Yaml])
      val hasScalaChunks = withoutFrontMatter.exists(_.isInstanceOf[Chunk.Scala])
      val exampleDashed = examplePath.segments.mkString("-")
      val download =
        s"{mill-download-url}/mill-dist-{mill-version}-$exampleDashed.zip[download]"
      val renderedChunks = withoutFrontMatter
        .map {
          case Chunk.See(path, lines) =>
            // avoid .stripMargin, as the embedded content may contain the margin symbol
            val lang = os.FilePath(path).ext match {
              case "mill" => "scala"
              case s => s
            }
            s"""
.$path ($download, {mill-example-url}/$examplePath/$path[browse])
[source,$lang,subs="attributes,verbatim"]
----
${lines.mkString("\n")}
----"""
          case Chunk.Scala(lines) =>
            val title =
              if (seenCode) ""
              else {
                s".build.mill ($download, {mill-example-url}/$examplePath[browse])"
              }
            seenCode = true
            // avoid .stripMargin, as the embedded content may contain the margin symbol
            s"""
$title
[source,scala,subs="attributes,verbatim"]
----

${
                if (seenFrontMatter) ""
                else {
                  seenFrontMatter = true
                  frontMatter
                }
              }

${lines.mkString("\n")}
----
"""
          case Chunk.Comment(lines) => lines.mkString("\n") + "\n"
          case Chunk.Usage(lines) =>
            // avoid .stripMargin, as the embedded content may contain the margin symbol
            s"""
[source,console,subs="attributes,verbatim"]
----
${lines.mkString("\n")}
----"""
          case Chunk.Yaml(_) => ""
        }
        .mkString("\n")

      // If no Scala chunks exist but we have front matter, include it at the top
      val finalContent = if (!hasScalaChunks && frontMatter.nonEmpty) {
        s"""
.build.mill ($download, {mill-example-url}/$examplePath[browse])
[source,scala,subs="attributes,verbatim"]
----
$frontMatter
----
""" + renderedChunks
      } else {
        renderedChunks
      }

      os.write(Task.dest / "example.adoc", finalContent)
      PathRef(Task.dest / "example.adoc")
    }
  }

  trait ExampleCrossModuleJavascript extends ExampleCrossModule {
    override def selectiveInputs = Seq(sources, build.libs.javascriptlib.sources)
  }

  trait ExampleCrossModulePython extends ExampleCrossModule {
    override def selectiveInputs = Seq(sources, build.libs.pythonlib.sources)
  }

  trait ExampleCrossModuleGroovy extends ExampleCrossModule {
    override def selectiveInputs = Seq(sources, build.libs.groovylib.sources)
  }

  trait ExampleCrossModuleMigrating extends ExampleCrossModule {
    override def selectiveInputs = Seq(
      sources,
      build.libs.init.sources,
      build.libs.init.maven.sources,
      build.libs.init.gradle.sources,
      build.libs.init.gradle.api.sources,
      build.libs.init.gradle.exportplugin.sources,
      build.libs.init.sbt.sources,
      build.libs.init.sbt.api(Deps.scalaVersion).sources,
      build.libs.init.sbt.exportplugin.sources,
      build.libs.init.buildgen.sources,
      build.libs.init.buildgen.api(Deps.scalaVersion).sources
    )
  }

  def repoInfo = Map(
    "acyclic" -> ("com-lihaoyi/acyclic", "4af02113286fcb3362f08e87ffbd14399e71c3b3"),
    "fansi" -> ("com-lihaoyi/fansi", "387754bc1fc0be0ac787b195490275012d80c683"),
    "jimfs" -> ("google/jimfs", "5b60a42eb9d3cd7a2073d549bd0cb833f5a7e7e9"),
    "commons-io" -> ("apache/commons-io", "b91a48074231ef813bc9b91a815d77f6343ff8f0"),
    "netty" -> ("netty/netty", "20a790ed362a3c11e0e990b58598e4ac6aa88bef"),
    "mockito" -> ("mockito/mockito", "97f3574cc07fdf36f1f76ba7332ac57675e140b1"),
    "gatling" -> ("gatling/gatling", "3870fda86e6bca005fbd53108c60a65db36279b6"),
    "arrow" -> ("arrow-kt/arrow", "bc9bf92cc98e01c21bdd2bf8640cf7db0f97204a"),
    "ollama-js" -> ("ollama/ollama-js", "99293abe2c7c27ce7e76e8b4a98cae948f00058d"),
    "androidtodo" -> ("android/architecture-samples", "b3437ab428f6fd91804b28801650d590ff52971c"),
    "android-endless-tunnel" -> ("android/ndk-samples", "46ac919196faf1efcfe8018a0dcc79d4f8fbeca7"),
    "android-compose-samples" -> (
      "android/compose-samples",
      "e4e6f0f96618f1ba04aa88d64ca19a166a662424"
    )
  )
  object thirdparty extends Cross[ThirdPartyModule](build.listCross)
  trait ThirdPartyModule extends ExampleCrossModule {
    val (repoPath, repoHash) = repoInfo(crossValue)
    def repoSlug = repoPath.split("/").last

    def downloadTestRepo(label: String, commit: String, dest: os.Path) = {
      os.unzip.stream(requests.get.stream(s"https://github.com/$label/archive/$commit.zip"), dest)
      dest
    }

    def downloadedRepo = Task {
      downloadTestRepo(repoPath, repoHash, Task.dest)
      val wrapperFolder = Task.dest / s"$repoSlug-$repoHash"
      PathRef(wrapperFolder)
    }

    def testRepoRoot = Task {
      val wrapperFolder = downloadedRepo().path
      os.copy(wrapperFolder, Task.dest, mergeFolders = true)
      os.copy(
        super.testRepoRoot().path,
        Task.dest,
        mergeFolders = true,
        replaceExisting = true
      )
      os.remove.all(Task.dest / ".mill-version")
      os.remove.all(Task.dest / ".mill-jvm-version")

      PathRef(Task.dest)
    }

    override def selectiveInputs =
      if (crossValue == "android-compose-samples") Seq(sources) ++ androidSelectiveInputs
      else null
  }
}
